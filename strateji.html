<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurumsal Stratejik Y√∂netim Paneli v2.0</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Presentation Mode Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,500;0,700;1,500&display=swap"
        rel="stylesheet">

    <style>
        /* --- TEMEL AYARLAR & DEƒûƒ∞≈ûKENLER --- */
        :root {
            /* Renk Paleti (Slate & Brand Colors) */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --border: #e2e8f0;

            /* Durum Renkleri */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;

            /* Tipografi */
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Playfair Display', serif;

            /* D√ºzen */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            line-height: 1.5;
            padding-top: 70px;
            /* Navbar space */
        }

        /* --- Tƒ∞POGRAFƒ∞ --- */
        h1,
        h2,
        h3,
        h4 {
            font-family: var(--font-serif);
            margin: 0;
            font-weight: 600;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: color 0.2s;
        }

        /* --- UI Bƒ∞LE≈ûENLERƒ∞ --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            background-color: var(--text-main);
            color: #fff;
            border: 1px solid var(--text-main);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-main);
            border-color: var(--border);
        }

        .btn-outline:hover {
            background-color: #f1f5f9;
            color: var(--text-main);
            border-color: #cbd5e1;
        }

        .btn-danger {
            background-color: #fff;
            color: var(--danger);
            border-color: #fee2e2;
        }

        .btn-danger:hover {
            background-color: #fef2f2;
            border-color: var(--danger);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background-color: #fff;
            color: var(--text-main);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            z-index: 1000;
        }

        .brand {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem 0;
            position: relative;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* --- LAYOUTS --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .hidden {
            display: none !important;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-sidebar {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
        }

        /* --- LANDING PAGE --- */
        #landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #fff;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .hero-title {
            font-size: 4rem;
            margin-bottom: 1rem;
            letter-spacing: -0.03em;
            color: var(--text-main);
        }

        .hero-text {
            font-size: 1.2rem;
            color: var(--text-muted);
            max-width: 600px;
            margin-bottom: 3rem;
        }

        /* --- TREE VIEW --- */
        .tree-item {
            padding: 4px 0;
            margin-left: 1rem;
            font-size: 0.9rem;
            border-left: 1px solid var(--border);
            padding-left: 0.8rem;
        }

        .tree-level-0 {
            margin-left: 0;
            border: none;
            font-weight: 700;
            margin-top: 1rem;
            color: var(--text-main);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .tree-level-1 {
            color: #0891b2;
            font-weight: 600;
        }

        .tree-level-2 {
            color: #059669;
        }

        .tree-level-3 {
            color: #6366f1;
            font-style: italic;
        }

        /* --- INDICATOR LIST --- */
        .ind-item {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            background: #fff;
        }

        .ind-item:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        /* --- REPORT CARDS --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: #fff;
            padding: 1rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            text-align: center;
        }

        .kpi-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0.5rem 0;
        }

        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* --- TABLE --- */
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .modern-table th {
            text-align: left;
            padding: 0.75rem;
            background: #f1f5f9;
            color: var(--text-muted);
            font-weight: 600;
        }

        .modern-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .cell-num {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* --- UTILS --- */
        .badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 99px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .bg-idari {
            background: #e0f2fe;
            color: #0369a1;
        }

        .bg-birim {
            background: #f0fdf4;
            color: #15803d;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-box {
            background: #fff;
            width: 90%;
            max-width: 500px;
            padding: 2rem;
            border-radius: var(--radius-md);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-box {
            transform: translateY(0);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: var(--text-main);
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-sm);
            margin-top: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* --- DATA SOURCE TREE & PLANNING --- */
        .tree-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            background: #f8fafc;
        }

        .tree-node {
            padding: 4px 0;
            font-size: 0.9rem;
        }

        .tree-children {
            margin-left: 1.5rem;
            border-left: 1px solid var(--border);
            padding-left: 0.8rem;
            display: none;
        }

        .tree-children.open {
            display: block;
        }

        .toggle-icon {
            cursor: pointer;
            display: inline-block;
            width: 16px;
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            user-select: none;
        }

        .planning-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .month-inputs {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Report Table Cells */
        .cell-real {
            background: #fff;
            font-weight: 500;
        }

        .cell-plan {
            background: #eff6ff;
            color: var(--primary);
            font-weight: 600;
            border-left: 2px solid var(--primary);
        }

        .cell-forecast {
            background: #fff7ed;
            color: var(--warning);
            font-style: italic;
            border-left: 2px solid var(--warning);
        }

        .quarter-col {
            background: #f1f5f9 !important;
            font-weight: 700;
        }

        .total-col {
            background: #e0f2fe !important;
            font-weight: 800;
            color: var(--primary);
        }

        .sparkline {
            width: 80px;
            height: 20px;
            color: var(--primary);
        }

        .kpi-period {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* --- PRESENTATION MODE --- */
        #presentation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #334155;
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #presentation-container.active {
            display: flex;
        }

        #presentation-viewport {
            width: 800px;
            height: 1131px;
            position: relative;
            background-color: white;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            -webkit-font-smoothing: antialiased;
            transform-origin: center center;
        }

        .presentation-slide {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: white;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .presentation-slide.active {
            display: flex;
            z-index: 10;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            z-index: 9999;
            background: white;
            width: 220px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            border: 1px solid #e2e8f0;
            padding: 5px 0;
        }

        .context-menu.show {
            display: block;
        }

        .menu-item {
            padding: 12px 20px;
            font-size: 14px;
            color: #334155;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background-color: #f1f5f9;
            color: #2563eb;
        }

        /* Loader */
        #pdf-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="landing-page">
        <h1 class="hero-title">Stratejik <span style="font-style:italic; color:var(--text-muted)">Y√∂netim.</span></h1>
        <p class="hero-text">Kurumsal hedefleri, performans g√∂stergelerini ve eylem planlarƒ±nƒ± tek bir merkezden
            y√∂netin.</p>
        <button onclick="app.init()" class="btn"
            style="padding: 1rem 3rem; font-size: 1.1rem; border-radius: 50px;">Sisteme Giri≈ü</button>
    </div>

    <nav class="navbar hidden" id="main-nav">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Stratejik Y√∂netim
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="app.switchTab('structure')">Yapƒ±landƒ±rma</div>
            <div class="nav-item" onclick="app.switchTab('builder')">Veri Giri≈üi</div>
            <div class="nav-item" onclick="app.switchTab('report')">Raporlar</div>
        </div>
        <div>
            <button class="btn btn-outline" style="font-size:0.8rem" onclick="modal.showDataManagement()">üìä Veri
                Y√∂netimi</button>
        </div>
    </nav>

    <main id="app-container" class="hidden">

        <div id="tab-structure" class="container">
            <div class="grid-sidebar">
                <div class="card" style="padding: 1.5rem; height: calc(100vh - 140px); overflow-y: auto;">
                    <h3
                        style="font-size:1rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:1rem;">
                        Kurum Yapƒ±sƒ±</h3>
                    <div id="structure-tree"></div>
                </div>

                <div class="card" style="padding: 2rem;">
                    <h2 style="margin-bottom: 2rem;">Hiyerar≈üi Tanƒ±mla</h2>

                    <div class="form-group"
                        style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:0.5rem;">üèõÔ∏è
                            Sorumlu M√ºd√ºrl√ºk</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="def-dir-name" class="form-input"
                                placeholder="√ñrn: Sosyal Hizmetler ≈ûube Md.">
                            <button class="btn" onclick="dataManager.addDefinition('directorate')">Ekle</button>
                        </div>
                    </div>

                    <div class="form-group"
                        style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:0.5rem;">üì¶ ƒ∞zleme
                            Modeli</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px;">
                            <select id="def-sel-dir" class="form-select" onchange="ui.updateDefSelects()">
                                <option value="">M√ºd√ºrl√ºk Se√ß...</option>
                            </select>
                            <input type="text" id="def-model-name" class="form-input" placeholder="Model Adƒ±">
                            <button class="btn" onclick="dataManager.addDefinition('model')">Ekle</button>
                        </div>
                    </div>

                    <div class="form-group"
                        style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:0.5rem;">üîë
                            Stratejik Ama√ß</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px;">
                            <select id="def-sel-model" class="form-select" onchange="ui.updateDefSelects()">
                                <option value="">Model Se√ß...</option>
                            </select>
                            <input type="text" id="def-goal-name" class="form-input" placeholder="Ama√ß Tanƒ±mƒ±">
                            <button class="btn" onclick="dataManager.addDefinition('goal')">Ekle</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:0.5rem;">üéØ Eylem
                            / Hedef</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px;">
                            <select id="def-sel-goal" class="form-select">
                                <option value="">Ama√ß Se√ß...</option>
                            </select>
                            <input type="text" id="def-action-name" class="form-input" placeholder="Eylem Tanƒ±mƒ±">
                            <button class="btn" onclick="dataManager.addDefinition('action')">Ekle</button>
                        </div>
                    </div>

                    <div
                        style="display:flex; justify-content:flex-end; margin-top:2rem; padding-top:1rem; border-top:1px solid var(--border);">
                        <button class="btn" onclick="ui.saveConfiguration()"
                            style="background-color:#0f172a; color:white; padding:0.8rem 2rem;">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-builder" class="container hidden">
            <div class="grid-sidebar">
                <div class="card" style="padding: 1.5rem; height: calc(100vh - 140px); overflow-y: auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                        <h3 style="font-size:1rem; margin:0;">G√∂stergeler</h3>
                        <button class="btn btn-outline" style="padding:0.3rem 0.6rem; font-size:0.8rem;"
                            onclick="ui.resetBuilderForm()">+ Yeni</button>
                    </div>
                    <div id="indicator-list"></div>
                </div>

                <div class="card" style="padding: 2rem; height: calc(100vh - 140px); overflow-y: auto;">
                    <input type="hidden" id="ind-id">

                    <h2 style="margin-bottom:1.5rem; border-bottom:1px solid var(--border); padding-bottom:1rem;">
                        G√∂sterge Detaylarƒ±</h2>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1.5rem;">
                        <div>
                            <label style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">M√ºd√ºrl√ºk</label>
                            <select id="ind-sel-dir" class="form-select" onchange="ui.filterBuilderModels()">
                                <option value="">Se√ßiniz...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">Model</label>
                            <select id="ind-sel-model" class="form-select" onchange="ui.filterBuilderGoals()">
                                <option value="">...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">Ama√ß</label>
                            <select id="ind-sel-goal" class="form-select" onchange="ui.filterBuilderActions()">
                                <option value="">...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">Eylem</label>
                            <select id="ind-sel-action" class="form-select">
                                <option value="">...</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block; font-weight:600; margin-bottom:0.5rem;">G√∂sterge Adƒ±</label>
                        <input type="text" id="ind-name" class="form-input"
                            placeholder="√ñrn: Nakdi Yardƒ±m Alan Ki≈üi Sayƒ±sƒ±">
                    </div>

                    <div
                        style="display:flex; gap:2rem; margin-bottom:2rem; padding:1rem; background:#f8fafc; border-radius:var(--radius-sm);">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="radio" name="ind-type" value="birim" checked> <span
                                class="badge bg-birim">Birim G√∂stergesi</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="radio" name="ind-type" value="idari"> <span class="badge bg-idari">ƒ∞dari
                                G√∂sterge</span>
                        </label>
                        <div style="margin-left:auto; display:flex; align-items:center; gap:5px;">
                            <label style="font-weight:600; font-size:0.8rem;">Hedef Yƒ±lƒ±:</label>
                            <input type="number" id="ind-year" value="2025" class="form-input"
                                style="width:80px; padding:0.3rem;">
                        </div>
                    </div>

                    <h4
                        style="margin-bottom:1rem; color:var(--text-muted); font-size:0.9rem; text-transform:uppercase;">
                        D√∂nemsel Hedefler (K√ºm√ºlatif)</h4>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:1rem; margin-bottom:2rem;">
                        <div><label style="font-size:0.75rem; display:block; text-align:center;">Q1</label><input
                                type="number" id="target-q1" class="form-input" style="text-align:center;"></div>
                        <div><label style="font-size:0.75rem; display:block; text-align:center;">Q2</label><input
                                type="number" id="target-q2" class="form-input" style="text-align:center;"></div>
                        <div><label style="font-size:0.75rem; display:block; text-align:center;">Q3</label><input
                                type="number" id="target-q3" class="form-input" style="text-align:center;"></div>
                        <div><label style="font-size:0.75rem; display:block; text-align:center;">Q4 (Yƒ±l)</label><input
                                type="number" id="target-q4" class="form-input"
                                style="text-align:center; font-weight:700;"></div>
                    </div>

                    <h4
                        style="margin-bottom:1rem; color:var(--text-muted); font-size:0.9rem; text-transform:uppercase;">
                        üìä Veri Kaynaklarƒ± (Opsiyonel)</h4>
                    <div id="datasource-container" style="margin-bottom:2rem;">
                        <button class="btn btn-outline" onclick="ui.renderDataSourceTree()" style="width:100%;">
                            Veri Kaynaklarƒ±nƒ± G√∂ster
                        </button>
                        <div id="data-source-tree" class="tree-container" style="margin-top:1rem; display:none;"></div>
                    </div>

                    <div id="planning-container" style="margin-bottom:2rem; display:none;">
                        <h4
                            style="margin-bottom:1rem; color:var(--text-muted); font-size:0.9rem; text-transform:uppercase;">
                            üìÖ Aylƒ±k Planlama</h4>
                        <div id="monthly-planning-inputs"></div>
                    </div>

                    <div style="display:flex; justify-content:flex-end;">
                        <button class="btn" onclick="dataManager.saveIndicator()">Kaydet ve Kapat</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-report" class="container hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h2>Performans Raporu</h2>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <!-- View Mode Selector -->
                    <div
                        style="display:flex; gap:1rem; padding:0.5rem 1rem; background:#f8fafc; border-radius:var(--radius-sm); border:1px solid var(--border);">
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer; font-size:0.9rem;">
                            <input type="radio" name="report-view-mode" value="standard" checked
                                onchange="chartManager.renderReport()"> Standart G√∂r√ºn√ºm
                        </label>
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer; font-size:0.9rem;">
                            <input type="radio" name="report-view-mode" value="presentation"
                                onchange="chartManager.renderReport()"> üìä Sunum Modu
                        </label>
                    </div>
                    <select id="report-filter-model" class="form-select" style="min-width:200px;">
                        <option value="all">T√ºm Modeller</option>
                    </select>
                    <button class="btn" onclick="chartManager.renderReport()">Raporla</button>
                </div>
            </div>

            <!-- Standard View Container -->
            <div id="report-content-standard">
                <div style="text-align:center; padding:4rem; color:var(--text-muted);">
                    Raporu g√∂r√ºnt√ºlemek i√ßin yukarƒ±dan se√ßim yapƒ±n veya "Raporla" butonuna basƒ±n.
                </div>
            </div>

            <!-- Presentation View Trigger -->
            <div id="report-content-presentation" style="text-align:center; padding:2rem; display:none;">
                <p style="color:var(--text-muted); margin-bottom:1rem;">Sunum modu hazƒ±r. Tam ekran g√∂r√ºn√ºm√º a√ßmak i√ßin
                    a≈üaƒüƒ±daki butona tƒ±klayƒ±n.</p>
                <button class="btn" onclick="presentationManager.openPresentation()"
                    style="padding:1rem 2rem; font-size:1.1rem;">üé¨ Sunum Modunu Ba≈ülat</button>
            </div>
        </div>

    </main>

    <div id="modal-data-management" class="modal-overlay">
        <div class="modal-box" style="max-width:600px;">
            <h3 style="margin-bottom:2rem;">üìä Veri Y√∂netimi</h3>

            <!-- Ham Veri B√∂l√ºm√º -->
            <div style="background:#f8fafc; padding:1.5rem; border-radius:var(--radius-sm); margin-bottom:2rem;">
                <h4 style="margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
                    <span>üìÇ</span> Ham Veri (Excel √ñl√ß√ºm Verileri)
                </h4>
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">
                    M√ºd√ºrl√ºk, Hizmet, T√ºr kolonlarƒ± i√ßeren Excel dosyanƒ±zƒ± y√ºkleyin.
                </p>
                <input type="file" id="raw-data-upload" accept=".xlsx,.xls" style="display:none"
                    onchange="fileIO.readDataFile(this.files[0])">
                <button class="btn" onclick="document.getElementById('raw-data-upload').click()" style="width:100%;">
                    üì§ Ham Veri Y√ºkle
                </button>
                <div style="margin-top:0.5rem; font-size:0.75rem; color:var(--text-muted); text-align:center;">
                    Y√ºkl√º Veri: <strong id="raw-data-count">0</strong> satƒ±r
                </div>
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin:2rem 0;">

            <!-- Sistem Ayarlarƒ± B√∂l√ºm√º -->
            <div style="background:#fff7ed; padding:1.5rem; border-radius:var(--radius-sm);">
                <h4 style="margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
                    <span>‚öôÔ∏è</span> Sistem Ayarlarƒ± (Tanƒ±mlar + G√∂stergeler)
                </h4>
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">
                    M√ºd√ºrl√ºk/Model/Hedef/Eylem tanƒ±mlarƒ± ve g√∂sterge ayarlarƒ±nƒ± <strong>Excel formatƒ±nda</strong>
                    yedekleyin veya geri y√ºkleyin.
                    <br><span style="color:#f59e0b; font-weight:500;">‚ö†Ô∏è Ayarlar otomatik kaydedilmez -
                        deƒüi≈üikliklerinizi "Ayarlarƒ± ƒ∞ndir" ile kaydedin!</span>
                </p>
                <div style="display:flex; gap:1rem;">
                    <button class="btn btn-outline" onclick="fileIO.exportSettings()" style="flex:1;">
                        üì• Ayarlarƒ± ƒ∞ndir (Excel)
                    </button>
                    <input type="file" id="settings-upload" accept=".xlsx,.xls" style="display:none"
                        onchange="fileIO.importSettings(this)">
                    <button class="btn" onclick="document.getElementById('settings-upload').click()" style="flex:1;">
                        üì§ Ayarlarƒ± Y√ºkle (Excel)
                    </button>
                </div>
                <div style="margin-top:0.5rem; font-size:0.75rem; color:var(--text-muted); text-align:center;">
                    G√∂sterge Sayƒ±sƒ±: <strong id="indicator-count">0</strong>
                </div>
            </div>

            <div style="margin-top:2rem; text-align:right;">
                <button class="btn btn-outline" onclick="modal.close()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Overlay -->
    <div id="presentation-container">
        <div id="presentation-viewport">
            <!-- Slides will be dynamically generated here -->
        </div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="context-menu">
        <div class="menu-item" onclick="presentationManager.toggleFullScreen()">
            Tam Ekran Yap
        </div>
        <div class="menu-item" onclick="presentationManager.nextSlide()">
            Sonraki Sayfa
        </div>
        <div class="menu-item" onclick="presentationManager.prevSlide()">
            √ñnceki Sayfa
        </div>
        <div style="height: 1px; background: #e2e8f0; margin: 5px 0;"></div>
        <div class="menu-item" onclick="presentationManager.downloadPDF()">
            <span class="text-red-500 font-bold" style="color:#ef4444; font-weight:700;">PDF Olarak ƒ∞ndir</span>
        </div>
        <div style="height: 1px; background: #e2e8f0; margin: 5px 0;"></div>
        <div class="menu-item" onclick="presentationManager.closePresentation()">
            <span style="color:#64748b;">Kapat</span>
        </div>
    </div>

    <!-- PDF Loader -->
    <div id="pdf-loader">
        <div class="spinner"></div>
        <div style="font-size:1.1rem; font-weight:700;">PDF Olu≈üturuluyor...</div>
        <div style="font-size:0.9rem; opacity:0.7; margin-top:0.5rem;">G√∂r√ºnt√º i≈üleniyor, l√ºtfen bekleyiniz.</div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- GLOBAL STATE ---
        const state = {
            data: { models: [], directorates: [], goals: [], actions: [] },
            indicators: [],
            rawData: [], // Excel'den y√ºklenen ham veri satƒ±rlarƒ±
            currentYear: new Date().getFullYear(),
            tempSelections: [] // G√∂sterge tanƒ±mlarken se√ßilen veri kaynaklarƒ± (ge√ßici)
        };

        // --- CORE APPLICATION ---
        const app = {
            init: () => {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('main-nav').classList.remove('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                // Removed: fileIO.loadLocal() - users must import Excel manually
                app.switchTab('structure');
            },

            switchTab: (tabName) => {
                document.querySelectorAll('#app-container > div').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const index = ['structure', 'builder', 'report'].indexOf(tabName);
                if (index > -1) document.querySelectorAll('.nav-item')[index].classList.add('active');

                // Tab specific updates
                if (tabName === 'structure') ui.renderStructureTree();
                if (tabName === 'builder') {
                    // Veri giri≈üi sekmesine ge√ßildiƒüinde dropdownlarƒ± g√ºncelle
                    ui.filterBuilderDirectorates();
                    ui.renderIndicatorList();
                }
                if (tabName === 'report') ui.populateReportFilter();
            },

            notify: (msg, type = 'info') => {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.style.background = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : 'var(--text-main)');
                toast.innerText = msg;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        // --- DATA MANAGER ---
        const dataManager = {
            addDefinition: (type) => {
                const id = Date.now().toString(36);
                let success = false;

                if (type === 'directorate') {
                    const val = document.getElementById('def-dir-name').value;
                    if (val) { state.data.directorates.push({ id, name: val }); document.getElementById('def-dir-name').value = ''; success = true; }
                }
                else if (type === 'model') {
                    const dirId = document.getElementById('def-sel-dir').value;
                    const val = document.getElementById('def-model-name').value;
                    if (dirId && val) { state.data.models.push({ id, directorateId: dirId, name: val }); document.getElementById('def-model-name').value = ''; success = true; }
                }
                else if (type === 'goal') {
                    const mId = document.getElementById('def-sel-model').value;
                    const val = document.getElementById('def-goal-name').value;
                    if (mId && val) { state.data.goals.push({ id, modelId: mId, name: val }); document.getElementById('def-goal-name').value = ''; success = true; }
                }
                else if (type === 'action') {
                    const gId = document.getElementById('def-sel-goal').value;
                    const val = document.getElementById('def-action-name').value;
                    if (gId && val) { state.data.actions.push({ id, goalId: gId, name: val }); document.getElementById('def-action-name').value = ''; success = true; }
                }

                if (success) {
                    fileIO.saveLocal();
                    ui.renderStructureTree();
                    ui.updateDefSelects();
                    app.notify('Kayƒ±t eklendi', 'success');
                } else {
                    app.notify('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                }
            },

            saveIndicator: () => {
                const idVal = document.getElementById('ind-id').value;
                const newItem = {
                    id: idVal ? parseInt(idVal) : Date.now(),
                    directorateId: document.getElementById('ind-sel-dir').value,
                    modelId: document.getElementById('ind-sel-model').value,
                    goalId: document.getElementById('ind-sel-goal').value,
                    actionId: document.getElementById('ind-sel-action').value,
                    name: document.getElementById('ind-name').value,
                    type: document.querySelector('input[name="ind-type"]:checked').value,
                    targetYear: parseInt(document.getElementById('ind-year').value),
                    targets: {
                        q1: parseFloat(document.getElementById('target-q1').value) || 0,
                        q2: parseFloat(document.getElementById('target-q2').value) || 0,
                        q3: parseFloat(document.getElementById('target-q3').value) || 0,
                        q4: parseFloat(document.getElementById('target-q4').value) || 0
                    },
                    selections: JSON.parse(JSON.stringify(state.tempSelections)) // Deep copy
                };

                if (!newItem.modelId || !newItem.name) return app.notify('Eksik bilgi', 'error');

                if (idVal) {
                    const idx = state.indicators.findIndex(i => i.id == idVal);
                    state.indicators[idx] = newItem;
                } else {
                    state.indicators.push(newItem);
                }

                fileIO.saveLocal();
                ui.renderIndicatorList();
                ui.resetBuilderForm();
                app.notify('G√∂sterge kaydedildi', 'success');
            },

            deleteIndicator: (id) => {
                if (confirm('Silmek istiyor musunuz?')) {
                    // Use loose equality != to handle string/number mismatch (e.g. from Excel vs Date.now())
                    state.indicators = state.indicators.filter(i => i.id != id);
                    fileIO.saveLocal();
                    ui.renderIndicatorList();
                }
            },

            deleteDefinition: (type, id, skipConfirm = false) => {
                // If skipConfirm is true (recursive call), we don't ask again.
                if (!skipConfirm) {
                    const confirmMsg = 'Bu tanƒ±mƒ± silmek istediƒüinizden emin misiniz? Baƒülƒ± olan t√ºm alt tanƒ±mlar ve g√∂stergeler de silinecektir!';
                    if (!confirm(confirmMsg)) return;
                }

                // Use loose equality != to handle string/number mismatch
                if (type === 'directorate') {
                    const modelsToDelete = state.data.models.filter(m => m.directorateId == id).map(m => m.id);
                    modelsToDelete.forEach(mid => dataManager.deleteDefinition('model', mid, true));
                    state.data.directorates = state.data.directorates.filter(d => d.id != id);
                } else if (type === 'model') {
                    const goalsToDelete = state.data.goals.filter(g => g.modelId == id).map(g => g.id);
                    goalsToDelete.forEach(gid => dataManager.deleteDefinition('goal', gid, true));
                    state.data.models = state.data.models.filter(m => m.id != id);
                    state.indicators = state.indicators.filter(i => i.modelId != id);
                } else if (type === 'goal') {
                    const actionsToDelete = state.data.actions.filter(a => a.goalId == id).map(a => a.id);
                    actionsToDelete.forEach(aid => dataManager.deleteDefinition('action', aid, true));
                    state.data.goals = state.data.goals.filter(g => g.id != id);
                    state.indicators = state.indicators.filter(i => i.goalId != id);
                } else if (type === 'action') {
                    state.data.actions = state.data.actions.filter(a => a.id != id);
                    state.indicators = state.indicators.filter(i => i.actionId != id);
                }

                fileIO.saveLocal();

                // Only refresh UI if it was the user-initiated action (not recursive)
                if (!skipConfirm) {
                    ui.renderStructureTree();
                    ui.updateDefSelects();
                    app.notify('Tanƒ±m silindi', 'success');
                }
            },

            getById: (collection, id) => state.data[collection].find(x => x.id == id) || { name: '-' }
        };

        // --- UI MANAGER ---
        const ui = {
            renderStructureTree: () => {
                const el = document.getElementById('structure-tree');
                if (!state.data.directorates.length) { el.innerHTML = '<div style="color:#ccc; text-align:center;">Hen√ºz yapƒ± yok.</div>'; return; }

                let html = '';
                state.data.directorates.forEach(d => {
                    html += `<div class="tree-level-0" style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem; margin-bottom:0.3rem;">
                        <span>üèõÔ∏è ${d.name}</span>
                        <div style="display:flex; gap:4px;">
                            <button class="btn btn-outline" style="padding:2px 8px; font-size:0.7rem;" onclick="ui.editDefinition('directorate', '${d.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" style="padding:2px 8px; font-size:0.7rem;" onclick="dataManager.deleteDefinition('directorate', '${d.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
                    state.data.models.filter(m => m.directorateId == d.id).forEach(m => {
                        html += `<div class="tree-item tree-level-1" style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem; margin-bottom:0.3rem;">
                            <span>üì¶ ${m.name}</span>
                            <div style="display:flex; gap:4px;">
                                <button class="btn btn-outline" style="padding:2px 8px; font-size:0.7rem;" onclick="ui.editDefinition('model', '${m.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger" style="padding:2px 8px; font-size:0.7rem;" onclick="dataManager.deleteDefinition('model', '${m.id}')">üóëÔ∏è</button>
                            </div>
                        </div>`;
                        state.data.goals.filter(g => g.modelId == m.id).forEach(g => {
                            html += `<div class="tree-item tree-level-2" style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem; margin-bottom:0.3rem;">
                                <span>üîë ${g.name}</span>
                                <div style="display:flex; gap:4px;">
                                    <button class="btn btn-outline" style="padding:2px 8px; font-size:0.7rem;" onclick="ui.editDefinition('goal', '${g.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-danger" style="padding:2px 8px; font-size:0.7rem;" onclick="dataManager.deleteDefinition('goal', '${g.id}')">üóëÔ∏è</button>
                                </div>
                            </div>`;
                            state.data.actions.filter(a => a.goalId == g.id).forEach(a => {
                                html += `<div class="tree-item tree-level-3" style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem; margin-bottom:0.3rem;">
                                    <span>üéØ ${a.name}</span>
                                    <div style="display:flex; gap:4px;">
                                        <button class="btn btn-outline" style="padding:2px 8px; font-size:0.7rem;" onclick="ui.editDefinition('action', '${a.id}')">‚úèÔ∏è</button>
                                        <button class="btn btn-danger" style="padding:2px 8px; font-size:0.7rem;" onclick="dataManager.deleteDefinition('action', '${a.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>`;
                            });
                        });
                    });
                });
                el.innerHTML = html;
            },

            updateDefSelects: () => {
                // Sadece Yapƒ±landƒ±rma Tabƒ± i√ßin
                const populate = (id, data, filterFn) => {
                    const el = document.getElementById(id);
                    if (!el) return; // Eleman yoksa hata verme
                    const current = el.value;
                    el.innerHTML = '<option value="">Se√ßiniz...</option>' + data.filter(filterFn).map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                    el.value = current;
                };

                populate('def-sel-dir', state.data.directorates, () => true);
                const dId = document.getElementById('def-sel-dir').value;
                populate('def-sel-model', state.data.models, x => x.directorateId == dId);
                const mId = document.getElementById('def-sel-model').value;
                populate('def-sel-goal', state.data.goals, x => x.modelId == mId);
                const gId = document.getElementById('def-sel-goal').value;
                // Eylem (Action) tanƒ±mlama i√ßin bir select yok ama mantƒ±k aynƒ±
            },

            editDefinition: (type, id) => {
                const item = dataManager.getById(type === 'directorate' ? 'directorates' : type === 'model' ? 'models' : type === 'goal' ? 'goals' : 'actions', id);
                const newName = prompt(`Yeni isim girin:`, item.name);
                if (!newName || newName.trim() === '') return;

                item.name = newName.trim();
                fileIO.saveLocal();
                ui.renderStructureTree();
                ui.updateDefSelects();
                app.notify('Tanƒ±m g√ºncellendi', 'success');
            },

            saveConfiguration: () => {
                fileIO.saveLocal();
                app.notify('Yapƒ±landƒ±rma kaydedildi', 'success');
            },

            // Builder Selects Logic (Cascading)
            filterBuilderDirectorates: () => {
                const el = document.getElementById('ind-sel-dir');
                if (!el) return;
                // Mevcut deƒüeri korumaya √ßalƒ±≈üma √ß√ºnk√º veri deƒüi≈ümi≈ü olabilir, resetle.
                el.innerHTML = '<option value="">Se√ßiniz...</option>' + state.data.directorates.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                // Alt men√ºleri de sƒ±fƒ±rla
                document.getElementById('ind-sel-model').innerHTML = '<option value="">Se√ßiniz...</option>';
                document.getElementById('ind-sel-goal').innerHTML = '<option value="">Se√ßiniz...</option>';
                document.getElementById('ind-sel-action').innerHTML = '<option value="">Se√ßiniz...</option>';
            },
            filterBuilderModels: () => {
                const id = document.getElementById('ind-sel-dir').value;
                const el = document.getElementById('ind-sel-model');
                el.innerHTML = '<option value="">Se√ßiniz...</option>' + state.data.models.filter(x => x.directorateId == id).map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                document.getElementById('ind-sel-goal').innerHTML = '<option value="">Se√ßiniz...</option>';
                document.getElementById('ind-sel-action').innerHTML = '<option value="">Se√ßiniz...</option>';
            },
            filterBuilderGoals: () => {
                const id = document.getElementById('ind-sel-model').value;
                const el = document.getElementById('ind-sel-goal');
                el.innerHTML = '<option value="">Se√ßiniz...</option>' + state.data.goals.filter(x => x.modelId == id).map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                document.getElementById('ind-sel-action').innerHTML = '<option value="">Se√ßiniz...</option>';
            },
            filterBuilderActions: () => {
                const id = document.getElementById('ind-sel-goal').value;
                const el = document.getElementById('ind-sel-action');
                el.innerHTML = '<option value="">Se√ßiniz...</option>' + state.data.actions.filter(x => x.goalId == id).map(x => `<option value="${x.id}">${x.name}</option>`).join('');
            },

            renderIndicatorList: () => {
                const list = document.getElementById('indicator-list');
                list.innerHTML = state.indicators.map(i => `
                    <div class="ind-item" onclick="ui.loadIndicatorToForm('${i.id}')">
                        <div>
                            <div style="font-weight:600; font-size:0.9rem;">${i.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">
                                ${dataManager.getById('models', i.modelId).name} > ${dataManager.getById('goals', i.goalId).name}
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span class="badge ${i.type === 'idari' ? 'bg-idari' : 'bg-birim'}">${i.type}</span>
                            <button class="btn btn-danger" style="padding:2px 6px; font-size:0.7rem;" onclick="event.stopPropagation(); dataManager.deleteIndicator('${i.id}')">Sil</button>
                        </div>
                    </div>
                `).join('');
            },

            loadIndicatorToForm: (id) => {
                const i = state.indicators.find(x => x.id == id);
                if (!i) return;
                document.getElementById('ind-id').value = i.id;
                document.getElementById('ind-name').value = i.name;
                document.getElementById('ind-year').value = i.targetYear || 2025;

                // Cascading selectleri sƒ±rayla doldur ve se√ß
                document.getElementById('ind-sel-dir').value = i.directorateId;
                ui.filterBuilderModels();

                document.getElementById('ind-sel-model').value = i.modelId;
                ui.filterBuilderGoals();

                document.getElementById('ind-sel-goal').value = i.goalId;
                ui.filterBuilderActions();

                document.getElementById('ind-sel-action').value = i.actionId;

                document.querySelector(`input[name="ind-type"][value="${i.type}"]`).checked = true;

                ['q1', 'q2', 'q3', 'q4'].forEach(q => document.getElementById(`target-${q}`).value = i.targets[q]);

                // Restore selections
                state.tempSelections = JSON.parse(JSON.stringify(i.selections || []));

                // Ensure legacy data has default useForecast=true if missing
                state.tempSelections.forEach(s => {
                    if (s.useForecast === undefined) s.useForecast = true;
                });

                if (state.tempSelections.length > 0 && state.rawData.length > 0) {
                    ui.renderDataSourceTree();
                    ui.renderPlanningInputs();
                }
            },

            resetBuilderForm: () => {
                document.getElementById('ind-id').value = '';
                document.getElementById('ind-name').value = '';
                ['q1', 'q2', 'q3', 'q4'].forEach(q => document.getElementById(`target-${q}`).value = '');
                state.tempSelections = [];
                document.getElementById('data-source-tree').style.display = 'none';
                document.getElementById('planning-container').style.display = 'none';

                // Dropdownlarƒ± da sƒ±fƒ±rla
                document.getElementById('ind-sel-dir').value = "";
                ui.filterBuilderModels();
            },

            renderDataSourceTree: () => {
                if (state.rawData.length === 0) {
                    return app.notify('√ñnce veri dosyasƒ± y√ºkleyin', 'error');
                }

                // Build hierarchy
                const hierarchy = {};
                state.rawData.forEach(row => {
                    if (!hierarchy[row.mudurluk]) hierarchy[row.mudurluk] = {};
                    if (!hierarchy[row.mudurluk][row.hizmet]) hierarchy[row.mudurluk][row.hizmet] = new Set();
                    hierarchy[row.mudurluk][row.hizmet].add(row.tur);
                });

                let html = '';
                Object.keys(hierarchy).sort().forEach(mud => {
                    const mudId = 'mud-' + mud.replace(/\s/g, '_');
                    const mudEsc = mud.replace(/'/g, "\\'");
                    html += `<div class="tree-node">
                        <span class="toggle-icon" onclick="ui.toggleTreeNode(this)">‚ñ∂</span>
                        <input type="checkbox" id="${mudId}" onchange="ui.onParentCheck(this, '${mudEsc}', null)"> <strong>${mud}</strong>
                        <div class="tree-children">`;

                    Object.keys(hierarchy[mud]).sort().forEach(hiz => {
                        const hizId = 'hiz-' + mud.replace(/\s/g, '_') + '-' + hiz.replace(/\s/g, '_');
                        const hizEsc = hiz.replace(/'/g, "\\'");
                        html += `<div class="tree-node" style="margin-left:1rem;">
                            <span class="toggle-icon" onclick="ui.toggleTreeNode(this)">‚ñ∂</span>
                            <input type="checkbox" id="${hizId}" onchange="ui.onParentCheck(this, '${mudEsc}', '${hizEsc}')"> ${hiz}
                            <div class="tree-children">`;

                        Array.from(hierarchy[mud][hiz]).sort().forEach(tur => {
                            const isChecked = state.tempSelections.some(s =>
                                s.mudurluk === mud && s.hizmet === hiz && s.tur === tur
                            );
                            const turEsc = tur.replace(/'/g, "\\'");
                            html += `<div class="tree-node" style="margin-left:1rem;">
                                <input type="checkbox" ${isChecked ? 'checked' : ''} class="chk-leaf"
                                    data-mud="${mud}" data-hiz="${hiz}"
                                    onchange="ui.onDataSourceCheck(this, '${mudEsc}', '${hizEsc}', '${turEsc}')">
                                ${tur}
                            </div>`;
                        });

                        html += `</div></div>`;
                    });

                    html += `</div></div>`;
                });

                const treeEl = document.getElementById('data-source-tree');
                treeEl.innerHTML = html;
                treeEl.style.display = 'block';

                // Auto-check parents
                ui.updateParentCheckboxes();
            },

            toggleTreeNode: (element) => {
                const children = element.parentElement.querySelector('.tree-children');
                if (children) {
                    const isOpen = children.classList.toggle('open');
                    element.textContent = isOpen ? '‚ñº' : '‚ñ∂';
                }
            },

            onParentCheck: (checkbox, mudurluk, hizmet) => {
                // Parent checkbox clicked - select/deselect all children
                const chks = document.querySelectorAll(`.chk-leaf[data-mud="${mudurluk}"]${hizmet ? `[data-hiz="${hizmet}"]` : ''}`);
                chks.forEach(c => {
                    c.checked = checkbox.checked;
                    c.dispatchEvent(new Event('change'));
                });
            },

            onDataSourceCheck: (checkbox, mudurluk, hizmet, tur) => {
                const index = state.tempSelections.findIndex(s =>
                    s.mudurluk === mudurluk && s.hizmet === hizmet && s.tur === tur
                );

                if (checkbox.checked && index === -1) {
                    state.tempSelections.push({
                        mudurluk,
                        hizmet,
                        tur,
                        plans: Array(12).fill(null),
                        useForecast: true // Default on
                    });
                } else if (!checkbox.checked && index !== -1) {
                    state.tempSelections.splice(index, 1);
                }

                ui.updateParentCheckboxes();
                ui.renderPlanningInputs();
            },

            updateParentCheckboxes: () => {
                // Update parent checkboxes based on children
                document.querySelectorAll('input[type="checkbox"][id^="mud-"], input[type="checkbox"][id^="hiz-"]').forEach(parent => {
                    const mud = parent.id.includes('mud-') ? parent.id.replace('mud-', '').replace(/_/g, ' ') : null;
                    const hiz = parent.id.includes('hiz-') ? parent.id.split('-')[2]?.replace(/_/g, ' ') : null;

                    let selector = '.chk-leaf';
                    if (mud && !hiz) selector += `[data-mud="${mud}"]`;
                    else if (hiz) {
                        const mudPart = parent.id.split('-')[1].replace(/_/g, ' ');
                        selector += `[data-mud="${mudPart}"][data-hiz="${hiz}"]`;
                    }

                    const children = document.querySelectorAll(selector);
                    const checkedChildren = Array.from(children).filter(c => c.checked);

                    if (checkedChildren.length === children.length && children.length > 0) {
                        parent.checked = true;
                        parent.indeterminate = false;
                    } else if (checkedChildren.length > 0) {
                        parent.indeterminate = true;
                    } else {
                        parent.checked = false;
                        parent.indeterminate = false;
                    }
                });
            },

            renderPlanningInputs: () => {
                const container = document.getElementById('monthly-planning-inputs');
                const planningSection = document.getElementById('planning-container');

                if (state.tempSelections.length === 0) {
                    planningSection.style.display = 'none';
                    return;
                }

                planningSection.style.display = 'block';

                let html = '';
                state.tempSelections.forEach((sel, idx) => {
                    const isForecastChecked = sel.useForecast !== false; // Default true

                    html += `<div class="planning-card">
                        <div style="font-weight:600; margin-bottom:0.5rem; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center;">
                            <span>${sel.mudurluk} > ${sel.hizmet} > ${sel.tur}</span>
                            <label style="font-size:0.75rem; display:flex; align-items:center; gap:4px; font-weight:normal; cursor:pointer; background:#eff6ff; padding:2px 8px; border-radius:4px;">
                                <input type="checkbox" ${isForecastChecked ? 'checked' : ''} onchange="ui.toggleForecast(${idx}, this.checked)">
                                üìà Otomatik Tahmin
                            </label>
                        </div>
                        <div class="month-inputs">`;

                    const months = ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                    for (let m = 0; m < 12; m++) {
                        html += `<div>
                            <label style="font-size:0.65rem; text-align:center; display:block;">${months[m]}</label>
                            <input type="number" value="${sel.plans[m] || ''}" 
                                onchange="ui.updatePlanValue(${idx}, ${m}, this.value)"
                                class="form-input" style="padding:0.3rem; text-align:center; font-size:0.8rem;">
                        </div>`;
                    }

                    html += `</div></div>`;
                });

                container.innerHTML = html;
            },

            toggleForecast: (index, checked) => {
                if (state.tempSelections[index]) {
                    state.tempSelections[index].useForecast = checked;
                }
            },

            updatePlanValue: (selIndex, monthIndex, value) => {
                if (state.tempSelections[selIndex]) {
                    state.tempSelections[selIndex].plans[monthIndex] = value ? parseFloat(value) : null;
                }
            },

            populateReportFilter: () => {
                const el = document.getElementById('report-filter-model');
                el.innerHTML = '<option value="all">T√ºm Modeller</option>' + state.data.models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            }
        };

        // --- CHART & REPORT MANAGER ---
        const chartManager = {
            calculateRealized: (indicator) => {
                const realized = Array(12).fill(0);
                const hasData = Array(12).fill(false);

                if (!indicator.selections || indicator.selections.length === 0) {
                    return { realized, lastRealizedIndex: -1 };
                }

                indicator.selections.forEach(sel => {
                    // Filter by K√úM√úLATIF (cumulative data)
                    const subset = state.rawData.filter(r =>
                        r.mudurluk === sel.mudurluk &&
                        r.hizmet === sel.hizmet &&
                        r.tur === sel.tur &&
                        r.tarih && r.tarih.getFullYear() === indicator.targetYear &&
                        r.veriAraligi && (r.veriAraligi.includes('K√úM√úLATIF') || r.veriAraligi.includes('K√úM√úLATƒ∞F'))
                    );

                    // For cumulative data: Take LATEST value per month per location
                    const latestByMonthLoc = {};

                    subset.forEach(row => {
                        const month = row.tarih.getMonth();
                        const loc = row.lokasyon || 'default';
                        const key = `${month}-${loc}`;

                        // Keep only the LATEST (most recent date) entry for this month-location
                        if (!latestByMonthLoc[key] || row.tarih > latestByMonthLoc[key].tarih) {
                            latestByMonthLoc[key] = { month, deger: row.deger, tarih: row.tarih };
                        }
                    });

                    // Sum across locations for each month (but data is already cumulative!)
                    Object.values(latestByMonthLoc).forEach(entry => {
                        if (entry.month >= 0 && entry.month < 12) {
                            realized[entry.month] += entry.deger; // Sum different locations
                            hasData[entry.month] = true;
                        }
                    });
                });

                const lastRealizedIndex = hasData.lastIndexOf(true);
                return { realized, lastRealizedIndex };
            },

            calculateForecast: (realized, lastRealizedIndex, ind) => {
                // Bottom-up aggregation: Sum of individual row forecasts
                // This ensures the chart matches the table's "General Total" exactly.

                const selections = ind.selections || [];
                if (selections.length === 0) return [...realized];

                let totalForecast = Array(12).fill(0);

                selections.forEach(sel => {
                    // 1. Get Realized Data for this selection (Row Level)
                    let compData = Array(12).fill(0);
                    const subset = state.rawData.filter(r =>
                        r.mudurluk === sel.mudurluk && r.hizmet === sel.hizmet && r.tur === sel.tur &&
                        r.tarih && r.tarih.getFullYear() === ind.targetYear &&
                        r.veriAraligi && (r.veriAraligi.includes('K√úM√úLATIF') || r.veriAraligi.includes('K√úM√úLATƒ∞F'))
                    );

                    const latest = {};
                    subset.forEach(r => {
                        const m = r.tarih.getMonth();
                        const loc = r.lokasyon || 'default';
                        const key = `${m}-${loc}`;
                        if (!latest[key] || r.tarih > latest[key].tarih) latest[key] = { m, val: r.deger, t: r.tarih };
                    });

                    Object.values(latest).forEach(v => {
                        if (v.m >= 0 && v.m < 12) compData[v.m] += v.val;
                    });

                    let lastReal = -1;
                    for (let m = 11; m >= 0; m--) {
                        if (compData[m] > 0) { lastReal = m; break; }
                    }

                    // 2. Calculate Trend for this selection
                    let rowForecast = [...compData];
                    let rowInc = [];
                    for (let i = 1; i <= lastReal; i++) rowInc.push(compData[i] - compData[i - 1]);

                    let rowAvgInc = 0;
                    let isDead = false;
                    if (rowInc.length >= 2) {
                        if (rowInc.slice(-2).every(x => x === 0)) isDead = true;
                    }

                    if (!isDead && rowInc.length > 0) {
                        rowAvgInc = rowInc.reduce((a, b) => a + b, 0) / rowInc.length;
                    }

                    // 3. Generate Forecast for this selection
                    const useRowForecast = sel.useForecast !== false;

                    for (let m = lastReal + 1; m < 12; m++) {
                        const prev = m > 0 ? rowForecast[m - 1] : 0;
                        if (sel.plans && sel.plans[m] !== null && sel.plans[m] !== undefined && sel.plans[m] !== '') {
                            rowForecast[m] = prev + parseFloat(sel.plans[m]);
                        } else if (useRowForecast) {
                            rowForecast[m] = prev + rowAvgInc;
                        } else {
                            rowForecast[m] = prev;
                        }
                        // Safety: Ensure strictly non-decreasing for cumulative data
                        if (rowForecast[m] < prev) rowForecast[m] = prev;
                    }

                    // 4. Add to total
                    for (let m = 0; m < 12; m++) totalForecast[m] += rowForecast[m];
                });

                return totalForecast;
            },
            renderReport: () => {
                const filterModel = document.getElementById('report-filter-model').value;
                const viewMode = document.querySelector('input[name="report-view-mode"]:checked').value;
                let indicators = state.indicators;

                if (filterModel !== 'all') {
                    indicators = indicators.filter(i => i.modelId == filterModel);
                }

                if (indicators.length === 0) {
                    document.getElementById('report-content-standard').innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted)">Veri bulunamadƒ±.</div>';
                    document.getElementById('report-content-presentation').style.display = 'none';
                    return;
                }

                // Route to appropriate view
                if (viewMode === 'presentation') {
                    // Show presentation trigger, hide standard
                    document.getElementById('report-content-standard').style.display = 'none';
                    document.getElementById('report-content-presentation').style.display = 'block';

                    // Store indicators for presentation manager
                    presentationManager.indicators = indicators;
                    return;
                } else {
                    // Show standard, hide presentation
                    document.getElementById('report-content-standard').style.display = 'block';
                    document.getElementById('report-content-presentation').style.display = 'none';
                }

                // === STANDARD VIEW RENDERING ===
                const container = document.getElementById('report-content-standard');

                // === 1. EXECUTIVE SUMMARY TABLE ===
                let summaryHtml = `
                <div class="card" style="margin-bottom:2rem;">
                    <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:#f8fafc;">
                        <h3>üìä Y√∂netici √ñzeti</h3>
                    </div>
                    <div style="padding:1.5rem; overflow-x:auto;">
                        <table class="modern-table" style="width:100%;">
                            <thead>
                                <tr style="background:#f8fafc;">
                                    <th style="text-align:left;">G√∂sterge Adƒ±</th>
                                    <th>Q1 (K√ºm.)</th><th>Q2 (K√ºm.)</th><th>Q3 (K√ºm.)</th><th>Q4 (K√ºm.)</th>
                                    <th style="border-left:2px solid #e2e8f0;">Yƒ±l Sonu (Mevcut)</th>
                                    <th>Yƒ±l Sonu (Tahmin)</th>
                                </tr>
                            </thead>
                            <tbody>`;

                indicators.forEach(ind => {
                    const { realized, lastRealizedIndex } = chartManager.calculateRealized(ind);
                    const forecast = chartManager.calculateForecast(realized, lastRealizedIndex, ind);
                    const t = ind.targets;

                    const qValues = [
                        lastRealizedIndex >= 2 ? realized[2] : forecast[2],
                        lastRealizedIndex >= 5 ? realized[5] : forecast[5],
                        lastRealizedIndex >= 8 ? realized[8] : forecast[8],
                        lastRealizedIndex >= 11 ? realized[11] : forecast[11]
                    ];

                    const targets = [t.q1, t.q2, t.q3, t.q4];
                    const currentTotal = lastRealizedIndex >= 0 ? realized[lastRealizedIndex] : 0;
                    const yearEndForecast = forecast[11];

                    let rowCells = '';
                    for (let i = 0; i < 4; i++) {
                        const isReal = (i * 3 + 2) <= lastRealizedIndex;
                        const val = qValues[i];
                        const target = targets[i];
                        let color = 'var(--text-main)';
                        if (target > 0) {
                            const pct = (val / target) * 100;
                            if (pct >= 95) color = 'var(--success)';
                            else if (pct >= 60) color = 'var(--warning)';
                            else color = 'var(--danger)';
                        }

                        rowCells += `<td>
                            <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
                                <span style="font-size:0.75rem; color:var(--text-muted); background:#f1f5f9; padding:2px 6px; border-radius:4px;">H: ${formatNumber(target)}</span>
                                <span style="font-weight:700; font-size:1.1rem; color:${isReal ? color : 'var(--text-muted)'}">${formatNumber(val)}</span>
                            </div>
                        </td>`;
                    }

                    summaryHtml += `<tr onclick="document.getElementById('chart-${ind.id}').scrollIntoView({behavior: 'smooth', block: 'center'});" style="cursor:pointer;">
                        <td style="text-align:left; font-weight:600;">${ind.name}</td>
                        ${rowCells}
                        <td style="border-left:1px solid #e2e8f0; background:#f0f9ff; font-weight:700; color:var(--primary);">${formatNumber(currentTotal)}</td>
                        <td style="font-weight:700;">${formatNumber(yearEndForecast)}</td>
                    </tr>`;
                });
                summaryHtml += `</tbody></table></div></div>`;

                // === 2. DETAILED CARDS ===
                let detailHtml = '';

                indicators.forEach(ind => {
                    const { realized, lastRealizedIndex } = chartManager.calculateRealized(ind);
                    const forecast = chartManager.calculateForecast(realized, lastRealizedIndex, ind);
                    const t = ind.targets;
                    const chartId = `chart-${ind.id}`;

                    // Fibonacci Projections
                    const highForecast = [...forecast];
                    const lowForecast = [...forecast];

                    if (lastRealizedIndex >= 0 && lastRealizedIndex < 11) {
                        for (let m = lastRealizedIndex + 1; m < 12; m++) {
                            const prevForecast = m > 0 ? forecast[m - 1] : 0;
                            const monthlyInc = forecast[m] - prevForecast;

                            const prevHigh = highForecast[m - 1];
                            const prevLow = lowForecast[m - 1];

                            highForecast[m] = prevHigh + (monthlyInc * 1.382);
                            lowForecast[m] = prevLow + (monthlyInc * 0.618);
                        }
                    }

                    // KPI Cards
                    const qValues = [forecast[2], forecast[5], forecast[8], forecast[11]];
                    const kpiHtml = ['Q1', 'Q2', 'Q3', 'Q4'].map((q, i) => {
                        const real = qValues[i];
                        const target = [t.q1, t.q2, t.q3, t.q4][i];
                        const pct = target > 0 ? Math.min((real / target) * 100, 100) : 0;
                        const color = pct >= 95 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444';
                        return `<div class="kpi-card">
                                    <div class="kpi-period">${q} (K√ºm.)</div>
                                    <div class="kpi-val">${formatNumber(real)}</div>
                                    <div class="kpi-label">Hedef: ${formatNumber(target)}</div>
                                    <div style="margin-top:8px; height:6px; background:#f1f5f9; border-radius:3px; overflow:hidden;">
                                        <div style="width:${pct}%; height:100%; background:${color};"></div>
                                    </div>
                                </div>`;
                    }).join('');

                    detailHtml += `
                    <div class="card" style="margin-bottom:3rem;">
                        <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:linear-gradient(to right, #ffffff, #f8fafc); display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.2rem;">
                                    ${dataManager.getById('models', ind.modelId).name}
                                </div>
                                <h3 style="font-size:1.4rem;">${ind.name}</h3>
                            </div>
                            <button class="btn btn-outline" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨Ü Yukarƒ±</button>
                        </div>
                        
                        <div style="padding:2rem;">
                            <!-- KPIs -->
                            <div class="kpi-grid" style="margin-bottom:2rem;">
                                ${kpiHtml}
                            </div>

                            <!-- Chart -->
                            <div style="margin-bottom:2rem;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                                    <h4 style="font-size:1.1rem;">Fibonacci Projeksiyon Konisi</h4>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">
                                        <span style="color:#22c55e;">‚óè ƒ∞yimser (1.382x)</span>
                                        <span style="color:#ef4444; margin-left:10px;">‚óè K√∂t√ºmser (0.618x)</span>
                                    </div>
                                </div>
                                <div style="height:400px; width:100%; border:1px solid var(--border); border-radius:12px; padding:1rem;">
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            </div>

                            <!-- Detail Table -->
                            <div style="overflow-x:auto;">
                                <div style="margin-bottom:0.5rem; font-size:0.75rem; color:var(--text-muted); display:flex; gap:1rem;">
                                    <span style="display:flex; align-items:center;"><span style="width:8px; height:8px; background:#dcfce7; display:inline-block; margin-right:4px;"></span> (P) Planlama (Eklenen)</span>
                                    <span style="display:flex; align-items:center;"><span style="width:8px; height:8px; background:#fef9c3; display:inline-block; margin-right:4px;"></span> (T) Akƒ±llƒ± Tahmin</span>
                                    <span style="display:flex; align-items:center;"><span style="font-weight:bold; color:var(--text-muted); margin-right:4px;">(i)</span> Tahmin Kapalƒ±ysa D√ºz Gider</span>
                                </div>
                                <table class="modern-table" style="width:100%; font-size:0.85rem;">
                                    <thead>
                                        <tr style="background:#f8fafc;">
                                            <th style="text-align:left;">Veri Kaynaƒüƒ±</th>
                                            <th>Oca</th><th>≈ûub</th><th style="background:#e0e7ff; color:#1e40af;">Mar</th>
                                            <th>Nis</th><th>May</th><th style="background:#e0e7ff; color:#1e40af;">Haz</th>
                                            <th>Tem</th><th>Aƒüu</th><th style="background:#e0e7ff; color:#1e40af;">Eyl</th>
                                            <th>Eki</th><th>Kas</th><th style="background:#e0e7ff; color:#1e40af;">Ara</th>
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ind.selections.map(sel => {
                        let compData = Array(12).fill(0);
                        const subset = state.rawData.filter(r =>
                            r.mudurluk === sel.mudurluk && r.hizmet === sel.hizmet && r.tur === sel.tur &&
                            r.tarih && r.tarih.getFullYear() === ind.targetYear &&
                            r.veriAraligi && (r.veriAraligi.includes('K√úM√úLATIF') || r.veriAraligi.includes('K√úM√úLATƒ∞F'))
                        );

                        const latest = {};
                        subset.forEach(r => {
                            const m = r.tarih.getMonth();
                            const loc = r.lokasyon || 'default';
                            const key = `${m}-${loc}`;
                            if (!latest[key] || r.tarih > latest[key].tarih) latest[key] = { m, val: r.deger, t: r.tarih };
                        });

                        Object.values(latest).forEach(v => {
                            if (v.m >= 0 && v.m < 12) compData[v.m] += v.val;
                        });

                        let lastReal = -1;
                        for (let m = 11; m >= 0; m--) {
                            if (compData[m] > 0) { lastReal = m; break; }
                        }

                        // Local Forecast Logic for Table Row
                        const sparkData = [];
                        let rowForecast = [...compData];

                        // Calculate specific row trend
                        let rowInc = [];
                        for (let i = 1; i <= lastReal; i++) rowInc.push(compData[i] - compData[i - 1]);

                        let rowAvgInc = 0;
                        let isDead = false;
                        if (rowInc.length >= 2) {
                            if (rowInc.slice(-2).every(x => x === 0)) isDead = true;
                        }

                        if (!isDead && rowInc.length > 0) {
                            rowAvgInc = rowInc.reduce((a, b) => a + b, 0) / rowInc.length;
                        }

                        const useRowForecast = sel.useForecast !== false;

                        for (let m = lastReal + 1; m < 12; m++) {
                            // FIX: Handle m=0 case
                            const prev = m > 0 ? rowForecast[m - 1] : 0;
                            if (sel.plans && sel.plans[m]) {
                                rowForecast[m] = prev + parseFloat(sel.plans[m]);
                            } else if (useRowForecast) {
                                rowForecast[m] = prev + rowAvgInc;
                            } else {
                                rowForecast[m] = prev;
                            }
                        }

                        // FIX: Sparkline to show cumulative trend, not increments
                        for (let m = 0; m < 12; m++) {
                            const val = rowForecast[m];
                            sparkData.push(val);
                        }
                        const sparkSvg = createSparkline(sparkData);

                        return `<tr>
                                                <td style="text-align:left;">${sel.hizmet} - ${sel.tur} <span style="font-size:0.7em; color:${useRowForecast ? '#22c55e' : '#94a3b8'}">${useRowForecast ? '(Tahmin A√ßƒ±k)' : '(Tahmin Kapalƒ±)'}</span></td>
                                                ${rowForecast.map((val, m) => {
                            const isQMonth = (m + 1) % 3 === 0;
                            let cellStyle = '';
                            let displayVal = val;
                            let suffix = '';

                            if (m > lastReal) {
                                // Future months
                                if (sel.plans && sel.plans[m] !== null && sel.plans[m] !== undefined && sel.plans[m] !== '') {
                                    cellStyle += 'color:#15803d; font-weight:600; font-style:italic;';
                                    displayVal = val;
                                } else if (useRowForecast && rowAvgInc > 0) {
                                    cellStyle += 'color:#ca8a04; font-weight:500; font-style:italic;';
                                    displayVal = val;
                                } else {
                                    // Flatline (either forecast disabled or trend is 0)
                                    cellStyle += 'color:#64748b; font-style:italic;';
                                    displayVal = val;
                                }
                            }

                            if (isQMonth) {
                                if (m <= lastReal) {
                                    cellStyle += 'background:#eff6ff; font-weight:700; color:#1e40af;';
                                } else {
                                    cellStyle += 'font-weight:600;';
                                }
                            }

                            return `<td style="${cellStyle}" title="${suffix}">${displayVal > 0 ? formatNumber(displayVal) : '-'}</td>`;
                        }).join('')}
                                                <td style="padding:0 5px;">${sparkSvg}</td>
                                            </tr>`;
                    }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;

                    setTimeout(() => {
                        const ctx = document.getElementById(chartId).getContext('2d');

                        const chartRealized = realized.map((v, i) => i <= lastRealizedIndex ? v : null);
                        const chartForecast = forecast.map((v, i) => {
                            if (i < lastRealizedIndex) return null;
                            if (i === lastRealizedIndex) return realized[i];
                            return v;
                        });
                        const chartHigh = highForecast.map((v, i) => {
                            if (i < lastRealizedIndex) return null;
                            if (i === lastRealizedIndex) return realized[i];
                            return v;
                        });
                        const chartLow = lowForecast.map((v, i) => {
                            if (i < lastRealizedIndex) return null;
                            if (i === lastRealizedIndex) return realized[i];
                            return v;
                        });

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'],
                                datasets: [
                                    {
                                        label: 'Ger√ßekle≈üen',
                                        data: chartRealized,
                                        borderColor: '#2563eb', backgroundColor: '#2563eb',
                                        borderWidth: 3, tension: 0.3, fill: false
                                    },
                                    {
                                        label: 'Akƒ±llƒ± Tahmin',
                                        data: chartForecast,
                                        borderColor: '#f97316', backgroundColor: '#f97316',
                                        borderWidth: 3, borderDash: [5, 5], tension: 0.3, fill: false
                                    },
                                    {
                                        label: 'ƒ∞yimser (1.382x)',
                                        data: chartHigh,
                                        borderColor: '#22c55e', borderWidth: 2, borderDash: [2, 2], tension: 0.3, fill: false
                                    },
                                    {
                                        label: 'K√∂t√ºmser (0.618x)',
                                        data: chartLow,
                                        borderColor: '#ef4444', borderWidth: 2, borderDash: [2, 2], tension: 0.3, fill: false
                                    },
                                    {
                                        label: 'Hedef (√áeyrek)',
                                        data: [0, null, t.q1, null, null, t.q2, null, null, t.q3, null, null, t.q4],
                                        borderColor: 'rgba(59, 130, 246, 0.6)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.25)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        fill: true,
                                        tension: 0.3,
                                        spanGaps: true
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { mode: 'index', intersect: false },
                                plugins: {
                                    legend: { position: 'bottom' },
                                    tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + formatNumber(c.raw) } }
                                },
                                scales: { y: { beginAtZero: true } }
                            }
                        });
                    }, 100);
                });

                container.innerHTML = summaryHtml + detailHtml;
            }
        };

        // --- PRESENTATION MANAGER ---
        const presentationManager = {
            indicators: [],
            currentSlide: 0,
            slides: [],
            viewport: null,
            container: null,
            // chartObserver removed

            openPresentation: () => {
                if (presentationManager.indicators.length === 0) {
                    return app.notify('√ñnce rapor olu≈üturun!', 'error');
                }

                presentationManager.container = document.getElementById('presentation-container');
                presentationManager.viewport = document.getElementById('presentation-viewport');
                presentationManager.ctxMenu = document.getElementById('ctx-menu');

                // Show container FIRST to ensure dimensions exist for charts
                presentationManager.container.classList.add('active');

                // Build slides
                presentationManager.buildSlides();

                presentationManager.showSlide(0);
                presentationManager.updateScale();

                // Add event listeners
                window.addEventListener('resize', presentationManager.updateScale);
                document.addEventListener('keydown', presentationManager.handleKey);
                presentationManager.container.addEventListener('contextmenu', presentationManager.showContextMenu);
                window.addEventListener('click', presentationManager.handleClick);
            },

            closePresentation: () => {
                presentationManager.container.classList.remove('active');
                presentationManager.ctxMenu.classList.remove('show');

                // Remove event listeners
                window.removeEventListener('resize', presentationManager.updateScale);
                document.removeEventListener('keydown', presentationManager.handleKey);
                presentationManager.container.removeEventListener('contextmenu', presentationManager.showContextMenu);
                window.removeEventListener('click', presentationManager.handleClick);
            },

            buildSlides: () => {
                const viewport = presentationManager.viewport;
                viewport.innerHTML = '';

                // Page 1: Executive Summary
                const summarySlide = presentationManager.createSummarySlide();
                viewport.appendChild(summarySlide);

                // Pages 2+: One slide per indicator
                presentationManager.indicators.forEach(ind => {
                    const indSlide = presentationManager.createIndicatorSlide(ind);
                    viewport.appendChild(indSlide);
                });

                presentationManager.slides = viewport.querySelectorAll('.presentation-slide');
            },

            // ... (buildSlides, createSummarySlide, createIndicatorSlide remain mostly the same, ensuring chartData is attached) ...

            showSlide: (index) => {
                presentationManager.slides.forEach(s => s.classList.remove('active'));
                if (index < 0) index = 0;
                if (index >= presentationManager.slides.length) index = presentationManager.slides.length - 1;
                presentationManager.currentSlide = index;
                presentationManager.slides[index].classList.add('active');
            },

            buildSlides: () => {
                const viewport = presentationManager.viewport;
                viewport.innerHTML = '';

                // Page 1: Executive Summary
                const summarySlide = presentationManager.createSummarySlide();
                viewport.appendChild(summarySlide);

                // Pages 2+: One slide per indicator
                presentationManager.indicators.forEach(ind => {
                    const indSlide = presentationManager.createIndicatorSlide(ind);
                    viewport.appendChild(indSlide);
                });

                presentationManager.slides = viewport.querySelectorAll('.presentation-slide');
            },

            createSummarySlide: () => {
                const slide = document.createElement('div');
                slide.className = 'presentation-slide';

                let summaryHtml = `
                    <div style="flex:1; display:flex; flex-direction:column; background:#f8fafc; padding:2rem;">
                        <div style="border-bottom:2px solid var(--primary); padding-bottom:1rem; margin-bottom:1.5rem;">
                            <h2 style="font-size:1.8rem; color:var(--text-main); margin:0;">üìä Y√∂netici √ñzeti</h2>
                            <p style="font-size:0.9rem; color:var(--text-muted); margin:0.5rem 0 0 0;">Genel Performans G√∂stergeleri</p>
                        </div>
                        <div style="overflow-y:auto; flex:1;">
                            <table class="modern-table" style="width:100%; font-size:0.8rem;">
                                <thead>
                                    <tr style="background:#fff;">
                                        <th style="text-align:left; padding:0.6rem;">G√∂sterge Adƒ±</th>
                                        <th style="padding:0.6rem;">Q1</th>
                                        <th style="padding:0.6rem;">Q2</th>
                                        <th style="padding:0.6rem;">Q3</th>
                                        <th style="padding:0.6rem;">Q4</th>
                                        <th style="padding:0.6rem; border-left:2px solid #e2e8f0;">Mevcut</th>
                                        <th style="padding:0.6rem;">Tahmin</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                presentationManager.indicators.forEach(ind => {
                    const { realized, lastRealizedIndex } = chartManager.calculateRealized(ind);
                    const forecast = chartManager.calculateForecast(realized, lastRealizedIndex, ind.selections || []);
                    const t = ind.targets;

                    const qValues = [
                        lastRealizedIndex >= 2 ? realized[2] : forecast[2],
                        lastRealizedIndex >= 5 ? realized[5] : forecast[5],
                        lastRealizedIndex >= 8 ? realized[8] : forecast[8],
                        lastRealizedIndex >= 11 ? realized[11] : forecast[11]
                    ];

                    const targets = [t.q1, t.q2, t.q3, t.q4];
                    const currentTotal = lastRealizedIndex >= 0 ? realized[lastRealizedIndex] : 0;
                    const yearEndForecast = forecast[11];

                    let rowCells = '';
                    for (let i = 0; i < 4; i++) {
                        const isReal = (i * 3 + 2) <= lastRealizedIndex;
                        const val = qValues[i];
                        const target = targets[i];
                        let color = 'var(--text-main)';
                        if (target > 0) {
                            const pct = (val / target) * 100;
                            if (pct >= 95) color = 'var(--success)';
                            else if (pct >= 60) color = 'var(--warning)';
                            else color = 'var(--danger)';
                        }

                        rowCells += `<td style="padding:0.6rem; text-align:center;">
                            <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:2px;">H: ${formatNumber(target)}</div>
                            <div style="font-weight:700; font-size:0.95rem; color:${isReal ? color : 'var(--text-muted)'}">${formatNumber(val)}</div>
                        </td>`;
                    }

                    summaryHtml += `<tr style="cursor:pointer;">
                        <td style="text-align:left; font-weight:600; padding:0.6rem; font-size:0.75rem;">${ind.name}</td>
                        ${rowCells}
                        <td style="border-left:1px solid #e2e8f0; background:#f0f9ff; font-weight:700; color:var(--primary); padding:0.6rem; text-align:center;">${formatNumber(currentTotal)}</td>
                        <td style="font-weight:700; padding:0.6rem; text-align:center;">${formatNumber(yearEndForecast)}</td>
                    </tr>`;
                });

                summaryHtml += `</tbody></table></div>
                    <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-size:0.75rem; color:var(--text-muted);">
                        <span>Stratejik Y√∂netim Paneli v2.0</span>
                        <span>Sayfa 1 / ${presentationManager.indicators.length + 1}</span>
                    </div>
                </div>`;

                slide.innerHTML = summaryHtml;
                return slide;
            },

            createIndicatorSlide: (ind) => {
                const slide = document.createElement('div');
                slide.className = 'presentation-slide';

                const { realized, lastRealizedIndex } = chartManager.calculateRealized(ind);
                const forecast = chartManager.calculateForecast(realized, lastRealizedIndex, ind);
                const t = ind.targets;
                const chartId = `pres-chart-${ind.id}`;

                // Calculate Optimistic (1.382x) and Pessimistic (0.618x) Scenarios
                const highForecast = forecast.map((v, i) => {
                    if (i < lastRealizedIndex) return null;
                    if (i === lastRealizedIndex) return realized[i];

                    // Calculate growth from last realized
                    const growth = v - realized[lastRealizedIndex];
                    return realized[lastRealizedIndex] + (growth * 1.382);
                });

                const lowForecast = forecast.map((v, i) => {
                    if (i < lastRealizedIndex) return null;
                    if (i === lastRealizedIndex) return realized[i];

                    // Calculate growth from last realized
                    const growth = v - realized[lastRealizedIndex];
                    return realized[lastRealizedIndex] + (growth * 0.618);
                });

                // KPI Logic
                const qEndMonths = [2, 5, 8, 11];
                const kpiHtml = ['Q1', 'Q2', 'Q3', 'Q4'].map((q, i) => {
                    const endMonth = qEndMonths[i];
                    const isFinished = lastRealizedIndex >= endMonth;
                    const target = [t.q1, t.q2, t.q3, t.q4][i];

                    let mainVal, mainLabel, subHtml = '';
                    let pct = 0;
                    let color = '#ef4444';

                    if (isFinished) {
                        // Finished Quarter: Show only Realized
                        mainVal = realized[endMonth];
                        mainLabel = 'Ger√ßekle≈üen';
                        pct = target > 0 ? Math.min((mainVal / target) * 100, 100) : 0;
                        color = pct >= 95 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444';

                        subHtml = `<div style="font-size:0.65rem; color:var(--text-muted); margin-bottom:0.5rem;">Hedef: ${formatNumber(target)}</div>`;
                    } else {
                        // Future/Ongoing Quarter: Show Forecast + Details
                        mainVal = forecast[endMonth];
                        mainLabel = 'Akƒ±llƒ± Tahmin';
                        pct = target > 0 ? Math.min((mainVal / target) * 100, 100) : 0;
                        color = pct >= 95 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444';

                        const currentReal = lastRealizedIndex >= 0 ? realized[lastRealizedIndex] : 0;
                        const optVal = highForecast[endMonth];
                        const pessVal = lowForecast[endMonth];

                        subHtml = `
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; font-size:0.6rem; color:var(--text-muted); margin-bottom:0.5rem; text-align:left;">
                                <div>Hedef: <span style="font-weight:600; color:var(--text-main);">${formatNumber(target)}</span></div>
                                <div>Mevcut: <span style="font-weight:600; color:var(--text-main);">${formatNumber(currentReal)}</span></div>
                                <div style="color:#15803d;">ƒ∞yimser: <span style="font-weight:600;">${formatNumber(optVal)}</span></div>
                                <div style="color:#b91c1c;">K√∂t√ºmser: <span style="font-weight:600;">${formatNumber(pessVal)}</span></div>
                            </div>
                        `;
                    }

                    return `<div style="background:#fff; padding:0.8rem; border-radius:8px; border:1px solid var(--border); text-align:center; display:flex; flex-direction:column; justify-content:center;">
                                <div style="font-size:0.65rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:0.3rem;">${q} (K√ºm.)</div>
                                <div style="font-size:1.2rem; font-weight:700; color:var(--text-main); margin:0.3rem 0;">${formatNumber(mainVal)}</div>
                                <div style="font-size:0.6rem; color:#64748b; margin-bottom:0.2rem;">${mainLabel}</div>
                                ${subHtml}
                                <div style="height:4px; background:#f1f5f9; border-radius:2px; overflow:hidden; margin-top:auto;">
                                    <div style="width:${pct}%; height:100%; background:${color};"></div>
                                </div>
                            </div>`;
                }).join('');

                const slideIdx = presentationManager.indicators.indexOf(ind) + 2;
                const totalSlides = presentationManager.indicators.length + 1;

                // Build detailed monthly table
                let tableRowsHtml = '';
                if (ind.selections && ind.selections.length > 0) {
                    tableRowsHtml = ind.selections.map(sel => {
                        let compData = Array(12).fill(0);
                        const subset = state.rawData.filter(r =>
                            r.mudurluk === sel.mudurluk && r.hizmet === sel.hizmet && r.tur === sel.tur &&
                            r.tarih && r.tarih.getFullYear() === ind.targetYear &&
                            r.veriAraligi && (r.veriAraligi.includes('K√úM√úLATIF') || r.veriAraligi.includes('K√úM√úLATƒ∞F'))
                        );

                        const latest = {};
                        subset.forEach(r => {
                            const m = r.tarih.getMonth();
                            const loc = r.lokasyon || 'default';
                            const key = `${m}-${loc}`;
                            if (!latest[key] || r.tarih > latest[key].tarih) latest[key] = { m, val: r.deger, t: r.tarih };
                        });

                        Object.values(latest).forEach(v => {
                            if (v.m >= 0 && v.m < 12) compData[v.m] += v.val;
                        });

                        let lastReal = -1;
                        for (let m = 11; m >= 0; m--) {
                            if (compData[m] > 0) { lastReal = m; break; }
                        }

                        const sparkData = [];
                        let rowForecast = [...compData];

                        let rowInc = [];
                        for (let i = 1; i <= lastReal; i++) rowInc.push(compData[i] - compData[i - 1]);

                        let rowAvgInc = 0;
                        let isDead = false;
                        if (rowInc.length >= 2) {
                            if (rowInc.slice(-2).every(x => x === 0)) isDead = true;
                        }

                        if (!isDead && rowInc.length > 0) {
                            rowAvgInc = rowInc.reduce((a, b) => a + b, 0) / rowInc.length;
                        }

                        const useRowForecast = sel.useForecast !== false;

                        for (let m = lastReal + 1; m < 12; m++) {
                            const prev = m > 0 ? rowForecast[m - 1] : 0;
                            if (sel.plans && sel.plans[m]) {
                                rowForecast[m] = prev + parseFloat(sel.plans[m]);
                            } else if (useRowForecast) {
                                rowForecast[m] = prev + rowAvgInc;
                            } else {
                                rowForecast[m] = prev;
                            }
                        }

                        for (let m = 0; m < 12; m++) {
                            sparkData.push(rowForecast[m]);
                        }
                        // const sparkSvg = createSparkline(sparkData); // Removed Trend Column

                        const monthCells = rowForecast.map((val, m) => {
                            const isQMonth = (m + 1) % 3 === 0;
                            let cellStyle = 'padding:0.4rem; text-align:center; font-size:0.7rem;';

                            if (m > lastReal) {
                                if (sel.plans && sel.plans[m] !== null && sel.plans[m] !== undefined && sel.plans[m] !== '') {
                                    cellStyle += 'color:#15803d; font-weight:600; font-style:italic;';
                                } else if (useRowForecast && rowAvgInc > 0) {
                                    cellStyle += 'color:#ca8a04; font-weight:500; font-style:italic;';
                                } else {
                                    cellStyle += 'color:#64748b; font-style:italic;';
                                }
                            }

                            if (isQMonth) {
                                if (m <= lastReal) {
                                    cellStyle += 'background:#eff6ff; font-weight:700; color:#1e40af;';
                                } else {
                                    cellStyle += 'font-weight:600;';
                                }
                            }

                            return `<td style="${cellStyle}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                        }).join('');

                        return `<tr>
                            <td style="text-align:left; padding:0.4rem; font-size:0.7rem; font-weight:600;">${sel.hizmet} - ${sel.tur}</td>
                            ${monthCells}
                        </tr>`;
                    }).join('');
                }

                // Calculate General Totals (Using the aggregated forecast directly)
                let generalRowHtml = '';
                if (ind.selections && ind.selections.length > 0) {
                    // Create Sparkline for General
                    // const sparkData = [];
                    // for (let m = 0; m < 12; m++) sparkData.push(forecast[m]);
                    // const sparkSvg = createSparkline(sparkData); // Removed Trend Column

                    const monthCells = forecast.map((val, m) => {
                        const isQMonth = (m + 1) % 3 === 0;
                        let cellStyle = 'padding:0.4rem; text-align:center; font-size:0.7rem; font-weight:700; color:var(--text-main);';

                        if (isQMonth) {
                            cellStyle += 'background:#eff6ff; color:#1e40af;';
                        }
                        return `<td style="${cellStyle}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                    }).join('');

                    generalRowHtml = `<tr style="background:#f1f5f9; border-top:2px solid #cbd5e1;">
                        <td style="text-align:left; padding:0.4rem; font-size:0.7rem; font-weight:800; color:var(--text-main);">GENEL TOPLAM</td>
                        ${monthCells}
                    </tr>`;
                }

                let slideHtml = `
                    <div style="height:100%; display:flex; flex-direction:column; overflow:hidden;">
                        <div style="padding:0.6rem 1rem; border-bottom:2px solid var(--primary); background:linear-gradient(to right, #ffffff, #f8fafc); flex-shrink:0;">
                            <div style="font-size:0.65rem; color:var(--text-muted); margin-bottom:0.1rem;">
                                ${dataManager.getById('models', ind.modelId).name}
                            </div>
                            <h2 style="font-size:1rem; margin:0; color:var(--text-main);">${ind.name}</h2>
                        </div>

                        <div style="flex:1; padding:0.6rem 1rem; background:#f8fafc; display:flex; flex-direction:column; gap:1rem; overflow:hidden;">
                            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:0.8rem; flex-shrink:0;">
                                ${kpiHtml}
                            </div>

                            <div style="background:#fff; padding:0.4rem; border-radius:6px; border:1px solid var(--border); height:180px; flex-shrink:0;">
                                <canvas id="${chartId}"></canvas>
                            </div>

                            ${tableRowsHtml ? `
                            <div style="background:#fff; padding:0.4rem; border-radius:6px; border:1px solid var(--border); flex:1; min-height:0; display:flex; flex-direction:column; margin-top:0.5rem;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem; flex-shrink:0;">
                                    <div style="font-size:0.65rem; font-weight:600; color:var(--text-main);">üìä Aylƒ±k Detay</div>
                                    <div style="font-size:0.55rem; color:var(--text-muted); display:flex; gap:0.5rem;">
                                        <span style="display:flex; align-items:center;"><span style="width:6px; height:6px; background:#15803d; display:inline-block; margin-right:3px;"></span> (P) Planlama</span>
                                        <span style="display:flex; align-items:center;"><span style="width:6px; height:6px; background:#ca8a04; display:inline-block; margin-right:3px;"></span> (T) Akƒ±llƒ± Tahmin</span>
                                        <span style="display:flex; align-items:center;"><span style="color:var(--text-muted); margin-right:2px;">(i)</span> Tahmin Kapalƒ±ysa D√ºz</span>
                                    </div>
                                </div>
                                <div style="overflow-x:auto; overflow-y:auto; flex:1; min-height:0;">
                                    <table class="modern-table" style="width:100%; font-size:0.65rem; table-layout:fixed;">
                                        <thead>
                                            <tr style="background:#f8fafc;">
                                                <th style="text-align:left; padding:0.25rem; font-size:0.6rem; width:15%;">Veri Kaynaƒüƒ±</th>
                                                <th style="padding:0.25rem; width:7.08%;">Oca</th><th style="padding:0.25rem; width:7.08%;">≈ûub</th><th style="padding:0.25rem; background:#e0e7ff; color:#1e40af; width:7.08%;">Mar</th>
                                                <th style="padding:0.25rem; width:7.08%;">Nis</th><th style="padding:0.25rem; width:7.08%;">May</th><th style="padding:0.25rem; background:#e0e7ff; color:#1e40af; width:7.08%;">Haz</th>
                                                <th style="padding:0.25rem; width:7.08%;">Tem</th><th style="padding:0.25rem; width:7.08%;">Aƒüu</th><th style="padding:0.25rem; background:#e0e7ff; color:#1e40af; width:7.08%;">Eyl</th>
                                                <th style="padding:0.25rem; width:7.08%;">Eki</th><th style="padding:0.25rem; width:7.08%;">Kas</th><th style="padding:0.25rem; background:#e0e7ff; color:#1e40af; width:7.08%;">Ara</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRowsHtml.replace(/padding:0.4rem/g, 'padding:0.2rem').replace(/font-size:0.7rem/g, 'font-size:0.65rem')}
                                            ${generalRowHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <div style="padding:0.4rem 1rem; border-top:1px solid var(--border); background:#fff; display:flex; justify-content:space-between; align-items:center; font-size:0.6rem; color:var(--text-muted); flex-shrink:0;">
                            <span>Stratejik Y√∂netim Paneli v2.0</span>
                            <span>Sayfa ${slideIdx} / ${totalSlides}</span>
                        </div>
                    </div>`;

                slide.innerHTML = slideHtml;

                // Schedule chart creation
                setTimeout(() => {
                    const canvas = slide.querySelector(`#${chartId}`);
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');
                    const chartRealized = realized.map((v, i) => i <= lastRealizedIndex ? v : null);
                    const chartForecast = forecast.map((v, i) => {
                        if (i < lastRealizedIndex) return null;
                        if (i === lastRealizedIndex) return realized[i];
                        return v;
                    });

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'],
                            datasets: [
                                {
                                    label: 'Ger√ßekle≈üen',
                                    data: chartRealized,
                                    borderColor: '#2563eb',
                                    backgroundColor: '#2563eb',
                                    borderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                    order: 1
                                },
                                {
                                    label: 'Akƒ±llƒ± Tahmin',
                                    data: chartForecast,
                                    borderColor: '#f97316',
                                    backgroundColor: '#f97316',
                                    borderWidth: 3,
                                    borderDash: [5, 5],
                                    tension: 0.3,
                                    fill: false,
                                    order: 2
                                },
                                {
                                    label: 'ƒ∞yimser (1.382x)',
                                    data: optimistic,
                                    borderColor: '#22c55e',
                                    backgroundColor: '#22c55e',
                                    borderWidth: 2,
                                    borderDash: [2, 2],
                                    tension: 0.3,
                                    fill: false,
                                    pointRadius: 2,
                                    order: 3
                                },
                                {
                                    label: 'K√∂t√ºmser (0.618x)',
                                    data: pessimistic,
                                    borderColor: '#ef4444',
                                    backgroundColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [2, 2],
                                    tension: 0.3,
                                    fill: false,
                                    pointRadius: 2,
                                    order: 4
                                },
                                {
                                    label: 'Hedef (√áeyrek)',
                                    data: [0, null, t.q1, null, null, t.q2, null, null, t.q3, null, null, t.q4],
                                    borderColor: 'rgba(59, 130, 246, 0.6)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    fill: true,
                                    tension: 0.3,
                                    spanGaps: true,
                                    order: 5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { position: 'bottom', labels: { boxWidth: 30, font: { size: 10 } } },
                                tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + formatNumber(c.raw) } }
                            },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }, 100);

                return slide;
            },

            showSlide: (index) => {
                presentationManager.slides.forEach(s => s.classList.remove('active'));
                if (index < 0) index = 0;
                if (index >= presentationManager.slides.length) index = presentationManager.slides.length - 1;
                presentationManager.currentSlide = index;

                const currentSlide = presentationManager.slides[index];
                currentSlide.classList.add('active');

                // Lazy load chart if exists and not rendered
                if (currentSlide.chartData && !currentSlide.chartRendered) {
                    const data = currentSlide.chartData;

                    // Use double requestAnimationFrame to ensure DOM is fully updated and painted
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const canvas = currentSlide.querySelector(`#${data.id}`);

                            if (canvas) {
                                // Force reflow to ensure dimensions are calculated
                                const _ = canvas.offsetHeight;

                                const ctx = canvas.getContext('2d');
                                const chartRealized = data.realized.map((v, i) => i <= data.lastRealizedIndex ? v : null);
                                const chartForecast = data.forecast.map((v, i) => {
                                    if (i < data.lastRealizedIndex) return null;
                                    if (i === data.lastRealizedIndex) return data.realized[i];
                                    return v;
                                });
                                const chartHigh = data.highForecast.map((v, i) => {
                                    if (i < data.lastRealizedIndex) return null;
                                    if (i === data.lastRealizedIndex) return data.realized[i];
                                    return v;
                                });
                                const chartLow = data.lowForecast.map((v, i) => {
                                    if (i < data.lastRealizedIndex) return null;
                                    if (i === data.lastRealizedIndex) return data.realized[i];
                                    return v;
                                });

                                new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'],
                                        datasets: [
                                            {
                                                label: 'Ger√ßekle≈üen',
                                                data: chartRealized,
                                                borderColor: '#2563eb', backgroundColor: '#2563eb',
                                                borderWidth: 3, tension: 0.3, fill: false
                                            },
                                            {
                                                label: 'Akƒ±llƒ± Tahmin',
                                                data: chartForecast,
                                                borderColor: '#f97316', backgroundColor: '#f97316',
                                                borderWidth: 3, borderDash: [5, 5], tension: 0.3, fill: false
                                            },
                                            {
                                                label: 'ƒ∞yimser (1.382x)',
                                                data: chartHigh,
                                                borderColor: '#22c55e', borderWidth: 2, borderDash: [2, 2], tension: 0.3, fill: false
                                            },
                                            {
                                                label: 'K√∂t√ºmser (0.618x)',
                                                data: chartLow,
                                                borderColor: '#ef4444', borderWidth: 2, borderDash: [2, 2], tension: 0.3, fill: false
                                            },
                                            {
                                                label: 'Hedef (√áeyrek)',
                                                data: [0, null, data.targets.q1, null, null, data.targets.q2, null, null, data.targets.q3, null, null, data.targets.q4],
                                                borderColor: 'rgba(59, 130, 246, 0.6)',
                                                backgroundColor: 'rgba(59, 130, 246, 0.25)',
                                                borderWidth: 2, pointRadius: 0, fill: true, tension: 0.3, spanGaps: true
                                            }
                                        ]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: { mode: 'index', intersect: false },
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + formatNumber(c.raw) } }
                                        },
                                        scales: { y: { beginAtZero: true } }
                                    }
                                });
                                currentSlide.chartRendered = true;
                            }
                        });
                    });
                }
            },

            nextSlide: () => presentationManager.showSlide(presentationManager.currentSlide + 1),
            prevSlide: () => presentationManager.showSlide(presentationManager.currentSlide - 1),

            updateScale: () => {
                if (document.fullscreenElement) {
                    presentationManager.viewport.style.transform = 'none';
                    presentationManager.viewport.style.width = '100vw';
                    presentationManager.viewport.style.height = '100vh';
                    return;
                }
                const targetW = 800;
                const targetH = 1131;
                const windowW = window.innerWidth - 40;
                const windowH = window.innerHeight - 40;
                const scale = Math.min(windowW / targetW, windowH / targetH);

                presentationManager.viewport.style.transform = `scale(${scale})`;
                presentationManager.viewport.style.width = '800px';
                presentationManager.viewport.style.height = '1131px';
            },

            handleKey: (e) => {
                if (e.key === 'ArrowRight' || e.key === ' ') presentationManager.nextSlide();
                if (e.key === 'ArrowLeft') presentationManager.prevSlide();
                if (e.key === 'Escape') {
                    if (presentationManager.ctxMenu.classList.contains('show')) {
                        presentationManager.ctxMenu.classList.remove('show');
                    } else if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        presentationManager.closePresentation();
                    }
                }
            },

            showContextMenu: (e) => {
                e.preventDefault();
                presentationManager.ctxMenu.style.left = `${e.clientX}px`;
                presentationManager.ctxMenu.style.top = `${e.clientY}px`;
                presentationManager.ctxMenu.classList.add('show');
            },

            handleClick: (e) => {
                if (!presentationManager.ctxMenu.contains(e.target)) {
                    presentationManager.ctxMenu.classList.remove('show');
                }
            },

            toggleFullScreen: () => {
                if (!document.fullscreenElement) {
                    presentationManager.container.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
                setTimeout(presentationManager.updateScale, 100);
            },

            downloadPDF: async () => {
                const loader = document.getElementById('pdf-loader');
                loader.style.display = 'flex';
                presentationManager.ctxMenu.classList.remove('show');

                const originalTransform = presentationManager.viewport.style.transform;
                presentationManager.viewport.style.transform = 'none';

                // Wait for fonts
                await document.fonts.ready;
                await new Promise(r => setTimeout(r, 800));

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', [595.28, 841.89]);
                const pdfW = 595.28;
                const pdfH = 841.89;

                try {
                    for (let i = 0; i < presentationManager.slides.length; i++) {
                        presentationManager.showSlide(i);
                        await new Promise(r => setTimeout(r, 1000));

                        const imgData = await htmlToImage.toPng(presentationManager.viewport, {
                            quality: 1.0,
                            pixelRatio: 2,
                            width: 800,
                            height: 1131,
                            backgroundColor: '#ffffff',
                            style: {
                                transform: 'none',
                                margin: 0
                            }
                        });

                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfW, pdfH);
                    }

                    pdf.save('Stratejik_Rapor.pdf');
                    app.notify('PDF ba≈üarƒ±yla indirildi!', 'success');

                } catch (err) {
                    console.error(err);
                    app.notify('PDF olu≈üturma hatasƒ±: ' + err.message, 'error');
                } finally {
                    loader.style.display = 'none';
                    presentationManager.viewport.style.transform = originalTransform;
                    presentationManager.showSlide(0);
                    presentationManager.updateScale();
                }
            }
        };

        // --- UTILITY FUNCTIONS ---
        const toJsDate = (val) => {
            if (!val) return null;
            if (typeof val === 'number') {
                return new Date((val - 25569) * 86400 * 1000); // Excel serial date
            }
            if (typeof val === 'string') {
                const parts = val.split(/[\.\-\/]/);
                if (parts.length === 3) {
                    return new Date(+parts[2], +parts[1] - 1, +parts[0]); // DD.MM.YYYY
                }
            }
            return new Date(val);
        };

        const createSparkline = (data) => {
            if (!data || data.length === 0) return '';
            const width = 100;
            const height = 30;
            const max = Math.max(...data, 1);
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - (d / max) * height;
                return `${x},${y}`;
            }).join(' ');
            return `<svg width="${width}" height="${height}" style="overflow:visible">
                <polyline points="${points}" fill="none" stroke="#3b82f6" stroke-width="2" />
                <circle cx="${width}" cy="${height - (data[data.length - 1] / max) * height}" r="3" fill="#3b82f6" />
            </svg>`;
        };

        const formatNumber = (num) => {
            return (num || 0).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
        };

        // --- FILE I/O & STORAGE ---
        const fileIO = {
            // Removed automatic localStorage - users must export/import Excel manually
            saveLocal: () => {
                const data = {
                    directorates: state.data.directorates,
                    models: state.data.models,
                    goals: state.data.goals,
                    actions: state.data.actions,
                    indicators: state.indicators
                };
                localStorage.setItem('strateji_data', JSON.stringify(data));
            },
            loadLocal: () => {
                const raw = localStorage.getItem('strateji_data');
                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        state.data.directorates = data.directorates || [];
                        state.data.models = data.models || [];
                        state.data.goals = data.goals || [];
                        state.data.actions = data.actions || [];
                        state.indicators = data.indicators || [];
                        ui.renderStructureTree();
                        ui.updateDefSelects();
                    } catch (e) {
                        console.error('Local data parse error', e);
                    }
                }
            },

            readDataFile: async (file) => {
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });

                    state.rawData = [];
                    let totalRows = 0;

                    workbook.SheetNames.forEach(sheetName => {
                        if (sheetName === 'Sistem_Tanimlari') return; // Skip system sheet

                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        console.log(`Sheet: ${sheetName}, Rows: ${rows.length}`);
                        if (rows.length > 0) console.log('Sample row:', rows[0]);

                        rows.forEach(row => {
                            // Flexible column names - support both formats
                            const mudurluk = row['M√ºd√ºrl√ºk'] || row['M√ºd√ºrluk'] || row['Mudurluk'];
                            const hizmet = row['Hizmet'] || row['Hizmet Ba≈ülƒ±ƒüƒ±'] || row['Hizmet Basligi'];
                            const tur = row['T√ºr'] || row['Tur'];

                            if (!mudurluk || !hizmet || !tur) {
                                return; // Skip incomplete rows
                            }

                            // Parse "Son Tarih"
                            let tarih = null;
                            const sonTarih = row['Son Tarih'] || row['Son Tarih'];

                            if (sonTarih) {
                                if (typeof sonTarih === 'number') {
                                    tarih = new Date((sonTarih - 25569) * 86400 * 1000);
                                } else if (typeof sonTarih === 'string') {
                                    const parts = sonTarih.split('.');
                                    if (parts.length === 3) {
                                        tarih = new Date(parts[2], parts[1] - 1, parts[0]);
                                    } else {
                                        tarih = new Date(sonTarih);
                                    }
                                } else {
                                    tarih = new Date(sonTarih);
                                }
                            }

                            if (!tarih || isNaN(tarih.getTime())) return;

                            const deger = parseFloat(row['Deƒüer'] || row['Deger']) || 0;
                            if (deger === 0) return;

                            state.rawData.push({
                                mudurluk: mudurluk,
                                hizmet: hizmet,
                                tur: tur,
                                lokasyon: row['Lokasyon'] || row['Lokasyon'] || 'Genel',
                                deger: deger,
                                tarih: tarih,
                                veriAraligi: (row['Veri Aralƒ±ƒüƒ±'] || row['Veri Araligi'] || '').toString().trim().toLocaleUpperCase('tr-TR')
                            });
                            totalRows++;
                        });
                    });

                    console.log(`Total loaded: ${state.rawData.length} rows`);

                    // Note: Settings are not auto-saved, use Excel export/import
                    app.notify(`${state.rawData.length} veri satƒ±rƒ± y√ºklendi (${workbook.SheetNames.length} sheet)`, 'success');
                    if (document.getElementById('raw-data-count')) {
                        modal.updateCounters();
                    }

                } catch (err) {
                    console.error('Excel okuma hatasƒ±:', err);
                    app.notify('Excel dosyasƒ± okunamadƒ±: ' + err.message, 'error');
                }
            },

            exportHierarchy: () => {
                try {
                    if (state.data.directorates.length === 0) {
                        return app.notify('Hen√ºz hi√ß tanƒ±m yok!', 'error');
                    }

                    const wb = XLSX.utils.book_new();
                    const rows = [];

                    state.data.directorates.forEach(dir => {
                        const models = state.data.models.filter(m => m.directorateId == dir.id);
                        if (models.length === 0) {
                            rows.push({
                                DirectorateID: dir.id, DirectorateName: dir.name,
                                ModelID: '', ModelName: '',
                                GoalID: '', GoalName: '',
                                ActionID: '', ActionName: ''
                            });
                        } else {
                            models.forEach(model => {
                                const goals = state.data.goals.filter(g => g.modelId == model.id);
                                if (goals.length === 0) {
                                    rows.push({
                                        DirectorateID: dir.id, DirectorateName: dir.name,
                                        ModelID: model.id, ModelName: model.name,
                                        GoalID: '', GoalName: '',
                                        ActionID: '', ActionName: ''
                                    });
                                } else {
                                    goals.forEach(goal => {
                                        const actions = state.data.actions.filter(a => a.goalId == goal.id);
                                        if (actions.length === 0) {
                                            rows.push({
                                                DirectorateID: dir.id, DirectorateName: dir.name,
                                                ModelID: model.id, ModelName: model.name,
                                                GoalID: goal.id, GoalName: goal.name,
                                                ActionID: '', ActionName: ''
                                            });
                                        } else {
                                            actions.forEach(action => {
                                                rows.push({
                                                    DirectorateID: dir.id, DirectorateName: dir.name,
                                                    ModelID: model.id, ModelName: model.name,
                                                    GoalID: goal.id, GoalName: goal.name,
                                                    ActionID: action.id, ActionName: action.name
                                                });
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });

                    const ws = XLSX.utils.json_to_sheet(rows);
                    XLSX.utils.book_append_sheet(wb, ws, 'Sistem_Tanimlari');
                    XLSX.writeFile(wb, 'Kurum_Hiyerarsisi.xlsx');
                    app.notify('Hiyerar≈üi indirildi!', 'success');
                } catch (err) {
                    console.error(err);
                    app.notify('ƒ∞ndirme hatasƒ±: ' + err.message, 'error');
                }
            },

            exportSettings: () => {
                try {
                    if (state.data.directorates.length === 0) {
                        return app.notify('Hen√ºz hi√ß tanƒ±m yok! √ñnce M√ºd√ºrl√ºk/Model/Ama√ß/Eylem tanƒ±mlarƒ±nƒ±zƒ± olu≈üturun.', 'error');
                    }

                    const wb = XLSX.utils.book_new();
                    const rows = [];

                    // Iterate through the entire hierarchy
                    state.data.directorates.forEach(dir => {
                        const models = state.data.models.filter(m => m.directorateId == dir.id);

                        if (models.length === 0) {
                            rows.push({
                                DirectorateID: dir.id, DirectorateName: dir.name,
                                ModelID: '', ModelName: '',
                                GoalID: '', GoalName: '',
                                ActionID: '', ActionName: '',
                                GostergeID: '', GostergeAdi: '', GostergeTipi: '', HedefYili: '',
                                H_Q1: '', H_Q2: '', H_Q3: '', H_Q4: '', SrcMud: '', SrcHiz: '', SrcTur: '',
                                TahminAktif: ''
                            });
                            return;
                        }

                        models.forEach(model => {
                            const goals = state.data.goals.filter(g => g.modelId == model.id);

                            if (goals.length === 0) {
                                rows.push({
                                    DirectorateID: dir.id, DirectorateName: dir.name,
                                    ModelID: model.id, ModelName: model.name,
                                    GoalID: '', GoalName: '',
                                    ActionID: '', ActionName: '',
                                    GostergeID: '', GostergeAdi: '', GostergeTipi: '', HedefYili: '',
                                    H_Q1: '', H_Q2: '', H_Q3: '', H_Q4: '', SrcMud: '', SrcHiz: '', SrcTur: '',
                                    TahminAktif: ''
                                });
                                return;
                            }

                            goals.forEach(goal => {
                                const actions = state.data.actions.filter(a => a.goalId == goal.id);

                                if (actions.length === 0) {
                                    rows.push({
                                        DirectorateID: dir.id, DirectorateName: dir.name,
                                        ModelID: model.id, ModelName: model.name,
                                        GoalID: goal.id, GoalName: goal.name,
                                        ActionID: '', ActionName: '',
                                        GostergeID: '', GostergeAdi: '', GostergeTipi: '', HedefYili: '',
                                        H_Q1: '', H_Q2: '', H_Q3: '', H_Q4: '', SrcMud: '', SrcHiz: '', SrcTur: '',
                                        TahminAktif: ''
                                    });
                                    return;
                                }

                                actions.forEach(action => {
                                    const inds = state.indicators.filter(i => i.actionId == action.id);

                                    if (inds.length === 0) {
                                        rows.push({
                                            DirectorateID: dir.id, DirectorateName: dir.name,
                                            ModelID: model.id, ModelName: model.name,
                                            GoalID: goal.id, GoalName: goal.name,
                                            ActionID: action.id, ActionName: action.name,
                                            GostergeID: '', GostergeAdi: '', GostergeTipi: '', HedefYili: '',
                                            H_Q1: '', H_Q2: '', H_Q3: '', H_Q4: '', SrcMud: '', SrcHiz: '', SrcTur: '',
                                            TahminAktif: ''
                                        });
                                    } else {
                                        inds.forEach(ind => {
                                            if (!ind.selections || ind.selections.length === 0) {
                                                rows.push({
                                                    DirectorateID: dir.id, DirectorateName: dir.name,
                                                    ModelID: model.id, ModelName: model.name,
                                                    GoalID: goal.id, GoalName: goal.name,
                                                    ActionID: action.id, ActionName: action.name,
                                                    GostergeID: ind.id, GostergeAdi: ind.name,
                                                    GostergeTipi: ind.type, HedefYili: ind.targetYear,
                                                    H_Q1: ind.targets.q1, H_Q2: ind.targets.q2,
                                                    H_Q3: ind.targets.q3, H_Q4: ind.targets.q4,
                                                    SrcMud: '', SrcHiz: '', SrcTur: '',
                                                    TahminAktif: ''
                                                });
                                            } else {
                                                ind.selections.forEach(sel => {
                                                    const row = {
                                                        DirectorateID: dir.id, DirectorateName: dir.name,
                                                        ModelID: model.id, ModelName: model.name,
                                                        GoalID: goal.id, GoalName: goal.name,
                                                        ActionID: action.id, ActionName: action.name,
                                                        GostergeID: ind.id, GostergeAdi: ind.name,
                                                        GostergeTipi: ind.type, HedefYili: ind.targetYear,
                                                        H_Q1: ind.targets.q1, H_Q2: ind.targets.q2,
                                                        H_Q3: ind.targets.q3, H_Q4: ind.targets.q4,
                                                        SrcMud: sel.mudurluk, SrcHiz: sel.hizmet, SrcTur: sel.tur,
                                                        TahminAktif: (sel.useForecast !== false) ? 1 : 0
                                                    };
                                                    if (sel.plans) {
                                                        sel.plans.forEach((p, i) => row[`P_${i + 1}`] = p || '');
                                                    }
                                                    rows.push(row);
                                                });
                                            }
                                        });
                                    }
                                });
                            });
                        });
                    });

                    if (rows.length === 0) {
                        return app.notify('Export edilecek veri yok!', 'error');
                    }

                    // Define fixed header order
                    const header = [
                        "DirectorateID", "DirectorateName",
                        "ModelID", "ModelName",
                        "GoalID", "GoalName",
                        "ActionID", "ActionName",
                        "GostergeID", "GostergeAdi", "GostergeTipi", "HedefYili",
                        "H_Q1", "H_Q2", "H_Q3", "H_Q4",
                        "SrcMud", "SrcHiz", "SrcTur", "TahminAktif",
                        "P_1", "P_2", "P_3", "P_4", "P_5", "P_6", "P_7", "P_8", "P_9", "P_10", "P_11", "P_12"
                    ];

                    const ws = XLSX.utils.json_to_sheet(rows, { header: header });
                    XLSX.utils.book_append_sheet(wb, ws, 'Sistem_Tanimlari');
                    XLSX.writeFile(wb, 'Kurumsal_Strateji_Sistemi.xlsx');
                    app.notify('Sistem ayarlarƒ± ba≈üarƒ±yla indirildi!', 'success');
                } catch (err) {
                    console.error('Export hatasƒ±:', err);
                    app.notify('Export ba≈üarƒ±sƒ±z: ' + err.message, 'error');
                }
            },

            importSettings: async (input) => {
                try {
                    const file = input.files[0];
                    if (!file) return;

                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(data, { type: 'array' });
                    const sheet = wb.Sheets['Sistem_Tanimlari'];

                    if (!sheet) {
                        return app.notify('Ge√ßersiz dosya formatƒ± (Sistem_Tanimlari sheet bulunamadƒ±)', 'error');
                    }

                    const rows = XLSX.utils.sheet_to_json(sheet);

                    // Parse data
                    const dirMap = new Map();
                    const modMap = new Map();
                    const goalMap = new Map();
                    const actMap = new Map();
                    const indicators = [];

                    rows.forEach(r => {
                        if (!dirMap.has(r.DirectorateID))
                            dirMap.set(r.DirectorateID, { id: r.DirectorateID, name: r.DirectorateName });

                        if (!modMap.has(r.ModelID))
                            modMap.set(r.ModelID, { id: r.ModelID, directorateId: r.DirectorateID, name: r.ModelName });

                        if (!goalMap.has(r.GoalID))
                            goalMap.set(r.GoalID, { id: r.GoalID, modelId: r.ModelID, name: r.GoalName });

                        if (!actMap.has(r.ActionID))
                            actMap.set(r.ActionID, { id: r.ActionID, goalId: r.GoalID, name: r.ActionName });

                        // Find or create indicator
                        let ind = indicators.find(i => i.id == r.GostergeID);
                        if (!ind) {
                            ind = {
                                id: r.GostergeID, modelId: r.ModelID, directorateId: r.DirectorateID,
                                goalId: r.GoalID, actionId: r.ActionID, name: r.GostergeAdi,
                                type: r.GostergeTipi, targetYear: r.HedefYili,
                                targets: { q1: r.H_Q1, q2: r.H_Q2, q3: r.H_Q3, q4: r.H_Q4 },
                                selections: []
                            };
                            indicators.push(ind);
                        }

                        // Add data source if present
                        if (r.SrcMud && r.SrcHiz && r.SrcTur) {
                            const plans = [];
                            for (let i = 1; i <= 12; i++) {
                                plans.push(r[`P_${i}`] || null);
                            }

                            // TahminAktif okuma: Excel'de yoksa varsayƒ±lan olarak 1 (true) kabul et
                            const useForecastVal = (r.TahminAktif !== undefined) ? r.TahminAktif : 1;

                            ind.selections.push({
                                mudurluk: r.SrcMud,
                                hizmet: r.SrcHiz,
                                tur: r.SrcTur,
                                plans,
                                useForecast: (useForecastVal == 1)
                            });
                        }
                    });

                    // Update state
                    state.data.directorates = Array.from(dirMap.values());
                    state.data.models = Array.from(modMap.values());
                    state.data.goals = Array.from(goalMap.values());
                    state.data.actions = Array.from(actMap.values());
                    state.indicators = indicators;

                    fileIO.saveLocal();

                    // Refresh UI without reloading page (to preserve rawData)
                    modal.updateCounters();
                    modal.close();

                    // --- D√úZELTME BA≈ûLANGICI ---
                    // √ñnceki kodda renderStructureList vardƒ±, bu fonksiyon tanƒ±mlƒ± deƒüildi.
                    // Doƒüru fonksiyon renderStructureTree'dir.
                    ui.renderStructureTree();

                    // Import sonrasƒ± state.data deƒüi≈ütiƒüi i√ßin dropdown'larƒ±n da g√ºncellenmesi gerekir.
                    ui.updateDefSelects();

                    // Eƒüer Builder (Veri Giri≈üi) sekmesindeki dropdownlarƒ±n da hemen dolmasƒ± isteniyorsa:
                    ui.filterBuilderDirectorates();

                    // --- D√úZELTME Bƒ∞Tƒ∞≈ûƒ∞ ---

                    ui.renderIndicatorList();
                    ui.populateReportFilter();

                    app.notify('Sistem ayarlarƒ± y√ºklendi! (' + indicators.length + ' g√∂sterge)', 'success');

                } catch (err) {
                    console.error('Import hatasƒ±:', err);
                    app.notify('Dosya okunamadƒ±: ' + err.message, 'error');
                }
            }
        };

        // --- MODAL UTILS ---
        const modal = {
            showDataManagement: () => {
                modal.updateCounters();
                document.getElementById('modal-data-management').classList.add('active');
            },
            close: () => document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')),
            updateCounters: () => {
                document.getElementById('raw-data-count').textContent = state.rawData.length;
                document.getElementById('indicator-count').textContent = state.indicators.length;
            }
        };

        // Pencere dƒ±≈üƒ±na tƒ±klayƒ±nca modal kapat
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) modal.close();
        }

    </script>
</body>

</html>