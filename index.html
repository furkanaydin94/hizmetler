<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosyal Hizmetler Portal</title>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Design System -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">

    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- JSZip Library (for Excel protection) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Portal Dashboard */
        .portal-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .portal-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .portal-header h1 {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-main);
        }

        .portal-content {
            flex: 1;
            padding: var(--space-8);
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* Section Styling */
        .portal-section {
            margin-bottom: var(--space-8);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border);
        }

        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
        }

        .section-title {
            font-size: var(--text-sm);
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin: 0;
        }

        .section-desc {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-left: auto;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--space-4);
        }

        .tool-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-5);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            text-decoration: none;
            transition: all var(--transition-base);
            cursor: pointer;
            text-align: center;
        }

        .tool-card:hover {
            border-color: var(--text-main);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .tool-icon {
            width: 40px;
            height: 40px;
            margin-bottom: var(--space-2);
            color: var(--text-main);
        }

        .tool-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--text-main);
        }

        .tool-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .tool-desc {
            font-size: 10px;
            color: var(--text-muted);
        }

        .tool-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-card.disabled:hover {
            border-color: var(--border);
            box-shadow: none;
            transform: none;
        }

        .coming-soon {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: var(--space-2);
        }

        .footer-text {
            text-align: center;
            padding: var(--space-4);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        /* Section Colors */
        .section-view .section-icon {
            color: #3b82f6;
        }

        .section-view .section-title {
            color: #3b82f6;
        }

        .section-create .section-icon {
            color: #16a34a;
        }

        .section-create .section-title {
            color: #16a34a;
        }
    </style>
</head>

<body>
    <div class="portal-container">
        <header class="portal-header">
            <h1>Sosyal Hizmetler Portal</h1>
        </header>

        <main class="portal-content">
            <!-- Rapor G√∂r√ºnt√ºle B√∂l√ºm√º -->
            <section class="portal-section section-view">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <h2 class="section-title">Rapor G√∂r√ºnt√ºle</h2>
                    <span class="section-desc" style="display:flex;align-items:center;gap:6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Veri D√∂nemi: <strong id="data-period" style="color:#3b82f6;">Y√ºkleniyor...</strong>
                        <button id="temp-data-btn" title="Ge√ßici Veri Y√ºkle"
                            style="margin-left:8px;padding:4px;background:#eff6ff;border:1px solid #3b82f6;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6"
                                stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                            </svg>
                        </button>
                    </span>
                </div>

                <div class="tools-grid">
                    <!-- Hizmet Kartlarƒ± -->
                    <a href="./gallery.html?autoGenerate=true" class="tool-card" id="hizmet-kartlari-btn">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </div>
                        <span class="tool-name">Hizmet Kartlarƒ±</span>
                        <span class="tool-desc">Lokasyon bazlƒ± raporlar</span>
                    </a>

                    <!-- Stratejik Y√∂netim -->
                    <a href="strateji-viewer.html" class="tool-card">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20v-4"></path>
                            </svg>
                        </div>
                        <span class="tool-name">Stratejik Y√∂netim</span>
                        <span class="tool-desc">Hedef ve g√∂sterge takibi</span>
                    </a>

                    <!-- Harita (Placeholder) -->
                    <div class="tool-card disabled">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                                <line x1="8" y1="2" x2="8" y2="18"></line>
                                <line x1="16" y1="6" x2="16" y2="22"></line>
                            </svg>
                        </div>
                        <span class="tool-name">Harita</span>
                        <span class="tool-desc">Coƒürafi g√∂rselle≈ütirme</span>
                        <span class="coming-soon">Yakƒ±nda</span>
                    </div>

                    <!-- ƒ∞statistikler -->
                    <a href="istatistikler.html" class="tool-card">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                        </div>
                        <span class="tool-name">ƒ∞statistikler</span>
                        <span class="tool-desc">Veri analizi</span>
                    </a>
                </div>
            </section>

            <!-- Rapor Olu≈ütur B√∂l√ºm√º -->
            <section class="portal-section section-create">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    <h2 class="section-title">Rapor Olu≈ütur</h2>
                    <span class="section-desc">Veri hazƒ±rlama ve yapƒ±landƒ±rma</span>
                </div>

                <div class="tools-grid">
                    <!-- Veri Kontrol -->
                    <a href="veri-kontrol.html" class="tool-card">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                        </div>
                        <span class="tool-name">Veri Kontrol</span>
                        <span class="tool-desc">Ham veri doƒürulama</span>
                    </a>

                    <!-- Dosya Hazƒ±rlama -->
                    <a href="dosya-hazirlama.html" class="tool-card">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <span class="tool-name">Dosya Hazƒ±rlama</span>
                        <span class="tool-desc">Rapor dosyasƒ± olu≈ütur</span>
                    </a>

                    <!-- G√∂sterge Tanƒ±mla -->
                    <a href="gosterge-tanimla.html" class="tool-card">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                        </div>
                        <span class="tool-name">G√∂sterge Tanƒ±mla</span>
                        <span class="tool-desc">Stratejik hedef yapƒ±landƒ±rma</span>
                    </a>

                    <!-- Veri Giri≈ü Taslaƒüƒ± -->
                    <div class="tool-card" onclick="openTemplateWizard()" style="cursor:pointer;">
                        <div class="tool-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                        </div>
                        <span class="tool-name">Veri Giri≈ü Taslaƒüƒ±</span>
                        <span class="tool-desc">Excel ≈üablonu olu≈ütur</span>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer-text">
            Sosyal Hizmetler Portal v15.0.0
        </footer>
    </div>

    <!-- Veri Giri≈ü Taslaƒüƒ± Modal -->
    <style>
        .tpl-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tpl-modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
    </style>
    <div id="template-modal" class="tpl-modal-overlay" style="display: none;">
        <div class="tpl-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b;">üìã Veri Giri≈ü Taslaƒüƒ± Olu≈ütur</h3>
                <button onclick="closeTemplateWizard()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
            </div>

            <!-- Step 1 -->
            <div id="template-step-1">
                <!-- Mode Se√ßimi -->
                <div
                    style="margin-bottom: 1.5rem; padding: 12px; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px;">
                    <label
                        style="font-weight: 600; font-size: 14px; color: #1e40af; display: block; margin-bottom: 10px;">üì¶
                        ƒ∞ndirme Modu</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label
                            style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: white; border-radius: 6px;">
                            <input type="radio" name="tpl-mode" value="single" checked onchange="handleModeChange()">
                            <div>
                                <div style="font-weight: 500; font-size: 13px;">Tek Dosya</div>
                                <div style="font-size: 11px; color: #64748b;">Bir m√ºd√ºrl√ºk/hizmet i√ßin Excel olu≈ütur
                                </div>
                            </div>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: white; border-radius: 6px;">
                            <input type="radio" name="tpl-mode" value="bulk" onchange="handleModeChange()">
                            <div>
                                <div style="font-weight: 500; font-size: 13px;">√áoklu Excel ƒ∞ndir (Toplu)</div>
                                <div style="font-size: 11px; color: #64748b;">T√ºm hizmetler i√ßin ZIP paketi olu≈ütur
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Toplu Mod M√ºd√ºrl√ºk Se√ßimi -->
                <div id="bulk-mode-mudurluk-select" style="display: none; margin-bottom: 1.5rem;">
                    <div style="padding: 12px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="font-weight: 600; font-size: 14px; color: #166534;">üìã Hangi
                                M√ºd√ºrl√ºkler?</label>
                            <div style="display: flex; gap: 6px;">
                                <button type="button" onclick="toggleAllMudurlukler(true)"
                                    style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ‚úì T√ºm√ºn√º Se√ß
                                </button>
                                <button type="button" onclick="toggleAllMudurlukler(false)"
                                    style="padding: 4px 8px; font-size: 11px; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ‚úó Temizle
                                </button>
                            </div>
                        </div>
                        <div id="bulk-mudurluk-list"
                            style="max-height: 180px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;">
                            <!-- Dinamik doldurulacak -->
                        </div>
                    </div>
                </div>

                <!-- Tek Dosya Modu ƒ∞√ßerikleri -->
                <div id="single-mode-content">
                    <!-- M√ºd√ºrl√ºk -->
                    <div style="margin-bottom: 1rem;">
                        <label
                            style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">M√ºd√ºrl√ºk</label>
                        <select id="tpl-mudurluk"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;"
                            onchange="handleMudurlukChange()">
                            <option value="">Y√ºkleniyor...</option>
                        </select>
                        <div id="tpl-mudurluk-new-container" style="display: none; margin-top: 8px;">
                            <input type="text" id="tpl-mudurluk-new" placeholder="Yeni m√ºd√ºrl√ºk adƒ±nƒ± girin..."
                                style="width: 100%; padding: 10px; border: 1px solid #10b981; border-radius: 6px; background: #ecfdf5;">
                        </div>
                    </div>

                    <!-- Hizmet Ba≈ülƒ±ƒüƒ± -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">Hizmet
                            Ba≈ülƒ±ƒüƒ±</label>
                        <select id="tpl-hizmet"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;"
                            onchange="handleHizmetChange()">
                            <option value="">√ñnce m√ºd√ºrl√ºk se√ßin...</option>
                        </select>
                        <div id="tpl-hizmet-new-container" style="display: none; margin-top: 8px;">
                            <input type="text" id="tpl-hizmet-new" placeholder="Yeni hizmet adƒ±nƒ± girin..."
                                style="width: 100%; padding: 10px; border: 1px solid #10b981; border-radius: 6px; background: #ecfdf5;">
                        </div>
                    </div>

                    <!-- T√ºr(ler) -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">T√ºr(ler)
                            <span style="color: #64748b; font-weight: 400;">(Her t√ºr i√ßin sorumlu ve ≈üifre
                                belirleyin)</span></label>
                        <div id="tpl-turler"
                            style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px; max-height: 280px; overflow-y: auto; background: #f8fafc;">
                            <p style="color: #64748b; font-size: 12px;">√ñnce hizmet se√ßin...</p>
                        </div>
                        <!-- Yeni T√ºr Ekleme -->
                        <div
                            style="margin-top: 10px; padding: 10px; background: #f0fdf4; border: 1px dashed #10b981; border-radius: 6px;">
                            <div style="font-size: 12px; font-weight: 500; color: #166534; margin-bottom: 8px;">‚ûï Yeni
                                T√ºr
                                Ekle</div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <input type="text" id="tpl-tur-new" placeholder="T√ºr adƒ±"
                                    style="flex: 1; min-width: 100px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px;">
                                <input type="text" id="tpl-tur-new-sorumlu" placeholder="Sorumlu"
                                    style="flex: 1; min-width: 100px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px;">
                                <input type="text" id="tpl-tur-new-sifre" placeholder="≈ûifre"
                                    style="width: 80px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px;">
                                <button onclick="addNewTur()" type="button"
                                    style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    Ekle
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ƒ∞l√ße Detayƒ± -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">ƒ∞l√ße
                            Detayƒ±
                            Var mƒ±?</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="tpl-ilce" value="yes" checked> Evet (40 il√ße)
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="tpl-ilce" value="no"> Hayƒ±r (ƒ∞stanbul Geneli)
                            </label>
                        </div>
                    </div>
                </div>

                <button onclick="showTemplateStep(2)"
                    style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">Devam
                    ‚Üí</button>
            </div>

            <!-- Step 2 -->
            <div id="template-step-2" style="display: none;">
                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">Hangi Yƒ±l
                        ƒ∞√ßin?</label>
                    <input type="number" id="tpl-year" value="2025" min="2020" max="2050"
                        style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                </div>

                <!-- BGG Tarihi (Sadece tek dosya modu i√ßin) -->
                <div id="single-mode-bgg-date" style="margin-bottom: 1rem;">
                    <label style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">BGG
                        Ba≈ülangƒ±√ß
                        Tarihi</label>
                    <input type="date" id="tpl-bgg-start"
                        style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                </div>

                <!-- Koruma Ayarlarƒ± (Tek Dosya Modu) -->
                <div id="single-mode-protection"
                    style="margin-bottom: 1.5rem; padding: 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 14px; color: #92400e; margin-bottom: 10px;">üîí Koruma
                        Ayarlarƒ±</div>
                    <div style="margin-bottom: 10px;">
                        <label
                            style="font-size: 12px; font-weight: 500; color: #78350f; display: block; margin-bottom: 4px;">
                            √áalƒ±≈üma Kitabƒ± ≈ûifresi <span style="font-weight: 400; color: #a16207;">(yapƒ±
                                korumasƒ±)</span>
                        </label>
                        <input type="text" id="tpl-kitap-sifre" placeholder="√ñrn: kitap123"
                            style="width: 100%; padding: 8px 10px; border: 1px solid #fbbf24; border-radius: 6px; font-size: 13px;">
                    </div>
                    <p style="font-size: 11px; color: #a16207; margin: 0;">
                        üí° Her t√ºr i√ßin K-L s√ºtunu ≈üifreleri Step 1'de belirlendi.
                    </p>
                </div>

                <!-- Toplu Mod Detay Tablosu -->
                <div id="bulk-mode-protection" style="display: none; margin-bottom: 1.5rem;">
                    <div
                        style="padding: 12px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-weight: 600; font-size: 13px; color: #166534; margin-bottom: 8px;">üìã
                            Hizmet ve T√ºr Detaylarƒ±</div>

                        <!-- ≈ûifre Koruma Checkbox -->
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-protection-checkbox"
                                    onchange="handleBulkProtectionCheckbox()">
                                <span style="font-size: 12px; font-weight: 500; color: #166534;">üîí ≈ûifre Korumasƒ±
                                    Ekle</span>
                            </label>
                            <div id="bulk-kitap-sifre-container" style="display: none; flex: 1;">
                                <input type="text" id="bulk-kitap-sifre"
                                    placeholder="√áalƒ±≈üma Kitabƒ± ≈ûifresi (T√ºm√º i√ßin)"
                                    style="width: 100%; padding: 6px 10px; border: 1px solid #10b981; border-radius: 6px; font-size: 12px;">
                            </div>
                        </div>

                        <div
                            style="max-height: 350px; overflow-y: auto; border: 1px solid #10b981; border-radius: 6px; background: white;">
                            <table id="bulk-hizmet-tur-table"
                                style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead style="background: #ecfdf5; position: sticky; top: 0;">
                                    <tr>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; min-width: 100px;">
                                            M√ºd√ºrl√ºk</th>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; min-width: 120px;">
                                            Hizmet</th>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; min-width: 60px;">
                                            T√ºr</th>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; width: 90px;">
                                            ƒ∞l√ße Detayƒ±</th>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; width: 100px;">
                                            BGG Tarihi</th>
                                        <th
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; min-width: 90px;">
                                            Sorumlu</th>
                                        <th id="bulk-sifre-header"
                                            style="padding: 6px; text-align: left; border-bottom: 1px solid #10b981; width: 70px; display: none;">
                                            K-L ≈ûifresi</th>
                                    </tr>
                                </thead>
                                <tbody id="bulk-hizmet-tur-tbody">
                                    <!-- Dinamik doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button onclick="showTemplateStep(1)"
                        style="flex: 1; padding: 12px; background: #f1f5f9; color: #475569; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">‚Üê
                        Geri</button>
                    <button onclick="generateDataTemplate()"
                        style="flex: 2; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">üì•
                        Excel Olu≈ütur</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    // ==================== IndexedDB Storage for Large Data ==================== //
    const DB_NAME = 'HizmetlerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'excelData';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
        });
    }

    async function saveToIndexedDB(key, data) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put({ id: key, data, timestamp: Date.now() });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function loadFromIndexedDB(key) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const request = tx.objectStore(STORE_NAME).get(key);
            request.onsuccess = () => resolve(request.result?.data);
            request.onerror = () => reject(request.error);
        });
    }

    async function clearIndexedDB() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).clear();
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    // ==================== Page Load: Restore from IndexedDB ==================== //
    (async function restoreFromIndexedDB() {
        try {
            const savedPeriod = await loadFromIndexedDB('data_period');
            const sheetsData = await loadFromIndexedDB('hizmet_sheets');
            const rawData = await loadFromIndexedDB('hizmet_rawdata');

            if (savedPeriod) {
                const periodEl = document.getElementById('data-period');
                if (periodEl) {
                    periodEl.textContent = savedPeriod;
                    periodEl.style.color = '#10b981';
                    console.log('üì¶ IndexedDB\'den veri d√∂nemi y√ºklendi:', savedPeriod);
                }
            }

            if (rawData && rawData.length > 0) {
                // Veriyi bellekte tut, localStorage/sessionStorage'a KOPYALAMA (5MB sƒ±nƒ±rƒ±!)
                window._indexedDBRawData = rawData; // Bellekte sakla
                console.log('üì¶ IndexedDB\'den', rawData.length, 'kayƒ±t y√ºklendi');
            }

            if (sheetsData && sheetsData.length > 0) {
                console.log('üì¶ IndexedDB\'den', sheetsData.length, 'sayfa y√ºklendi (indirme i√ßin hazƒ±r)');
            }
        } catch (err) {
            console.log('IndexedDB y√ºklenemedi:', err.message);
        }
    })();

    // Load data period from localStorage (temp data) or Excel (default)
    (async function loadDataPeriod() {
        const periodEl = document.getElementById('data-period');

        // √ñnce localStorage'dan ge√ßici veri d√∂nemi kontrol√º
        const tempPeriod = localStorage.getItem('temp_data_period');
        if (tempPeriod) {
            periodEl.textContent = tempPeriod;
            periodEl.style.color = '#10b981'; // Ye≈üil: ge√ßici veri aktif
            console.log('üìÖ Ge√ßici veri d√∂nemi y√ºklendi:', tempPeriod);
            return; // Ge√ßici veri varsa veri.xlsx'i y√ºkleme
        }

        try {
            const response = await fetch('hizmet-verileri/veri.xlsx');
            if (!response.ok) throw new Error('Dosya bulunamadƒ±');
            const buffer = await response.arrayBuffer();
            const wb = XLSX.read(buffer, { type: 'array' });

            let maxDate = null;
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];

            // Search all sheets for Son Tarih column
            wb.SheetNames.forEach(sheetName => {
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                rows.forEach(row => {
                    let tarih = row['Son Tarih'];
                    if (tarih) {
                        let d = null;
                        if (typeof tarih === 'number') {
                            d = new Date((tarih - 25569) * 86400 * 1000);
                        } else if (typeof tarih === 'string') {
                            const parts = tarih.split('.');
                            if (parts.length === 3) d = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        if (d && !isNaN(d) && (maxDate === null || d > maxDate)) {
                            maxDate = d;
                        }
                    }
                });
            });

            if (maxDate) {
                periodEl.textContent = monthNames[maxDate.getMonth()] + ' ' + maxDate.getFullYear();
            } else {
                periodEl.textContent = 'Bilinmiyor';
            }
        } catch (err) {
            console.error('Veri d√∂nemi okunamadƒ±:', err);
            periodEl.textContent = 'Okunamadƒ±';
        }
    })();

    // Temp Data Modal Logic
    const tempDataBtn = document.getElementById('temp-data-btn');
    let tempModal = null;

    tempDataBtn.addEventListener('click', () => {
        if (tempModal) {
            tempModal.remove();
        }

        tempModal = document.createElement('div');
        tempModal.innerHTML = `
            <div style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;">
                <div style="background:white;border-radius:12px;padding:24px;max-width:400px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.2);">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                        <h3 style="margin:0;font-size:18px;font-weight:600;color:#1e293b;">Ge√ßici Veri Y√ºkle</h3>
                        <button id="close-temp-modal" style="background:none;border:none;cursor:pointer;padding:4px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <p style="color:#64748b;font-size:13px;margin-bottom:16px;">Y√ºklenen veriler sadece bu oturum i√ßin ge√ßerlidir. Sayfa yenilendiƒüinde varsayƒ±lan veriler kullanƒ±lƒ±r.</p>
                    
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <label style="display:flex;align-items:center;gap:12px;padding:14px;border:1px dashed #cbd5e1;border-radius:8px;cursor:pointer;transition:all 0.2s;" id="hizmet-upload-label">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <div>
                                <div style="font-weight:500;color:#1e293b;">Hizmet Verileri</div>
                                <div style="font-size:12px;color:#64748b;" id="hizmet-status">Excel dosyalarƒ± se√ßin (birden fazla olabilir)</div>
                            </div>
                            <input type="file" id="hizmet-file" accept=".xlsx,.xls" multiple style="display:none;">
                        </label>
                        
                        <label style="display:flex;align-items:center;gap:12px;padding:14px;border:1px dashed #cbd5e1;border-radius:8px;cursor:pointer;transition:all 0.2s;" id="gosterge-upload-label">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20v-4"></path>
                            </svg>
                            <div>
                                <div style="font-weight:500;color:#1e293b;">G√∂stergeler</div>
                                <div style="font-size:12px;color:#64748b;" id="gosterge-status">Excel dosyasƒ± se√ßin</div>
                            </div>
                            <input type="file" id="gosterge-file" accept=".xlsx,.xls" style="display:none;">
                        </label>
                    </div>
                    
                    <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;">
                        <button id="clear-temp-data" style="padding:8px 16px;background:#fee2e2;color:#dc2626;border:none;border-radius:6px;cursor:pointer;font-size:13px;">Temizle</button>
                        <button id="download-merged-data" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;display:none;">ƒ∞ndir</button>
                        <button id="apply-temp-data" style="padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">Uygula</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(tempModal);

        // Event Listeners
        document.getElementById('close-temp-modal').onclick = () => tempModal.remove();
        tempModal.querySelector('div').onclick = (e) => { if (e.target === tempModal.querySelector('div')) tempModal.remove(); };

        // Modal a√ßƒ±ldƒ±ƒüƒ±nda IndexedDB'den mevcut veriyi kontrol et
        (async function checkExistingData() {
            try {
                const sheetsData = await loadFromIndexedDB('hizmet_sheets');
                const rawData = await loadFromIndexedDB('hizmet_rawdata');

                if (sheetsData && sheetsData.length > 0) {
                    // Veri var - ƒ∞ndir butonunu g√∂ster ve durumu g√ºncelle
                    document.getElementById('download-merged-data').style.display = 'block';
                    document.getElementById('hizmet-status').textContent = '‚úì ' + (rawData?.length || 0) + ' kayƒ±t, ' + sheetsData.length + ' sayfa mevcut';
                    document.getElementById('hizmet-upload-label').style.borderColor = '#3b82f6';
                    document.getElementById('hizmet-upload-label').style.background = '#eff6ff';
                    console.log('üì¶ Modal: IndexedDB\'den mevcut veri bulundu:', sheetsData.length, 'sayfa');
                }
            } catch (e) {
                // IndexedDB eri≈üim hatasƒ± - sessizce devam et
            }
        })();

        // File handlers
        document.getElementById('hizmet-file').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            try {
                const rawData = [];
                const allSheets = []; // T√úM sayfalarƒ± sakla (indirme i√ßin - aynƒ± isimli sayfalar birle≈ütirilir)
                let maxDate = null;
                const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];

                for (const file of files) {
                    const buffer = await file.arrayBuffer();
                    const wb = XLSX.read(buffer, { type: 'array' });

                    // T√úM sayfalarƒ± i≈üle (sadece ilk sayfayƒ± deƒüil)
                    wb.SheetNames.forEach(sheetName => {
                        if (sheetName === 'Sistem_Tanimlari') return;

                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);

                        // Aynƒ± isimli sayfa varsa satƒ±rlarƒ± alt alta ekle (birle≈ütir)
                        const existingSheet = allSheets.find(s => s.name === sheetName);
                        if (existingSheet) {
                            // Mevcut sayfaya satƒ±rlarƒ± ekle
                            existingSheet.rows = existingSheet.rows.concat(rows);
                            existingSheet.sourceFiles.push(file.name);
                        } else {
                            // Yeni sayfa olu≈ütur
                            allSheets.push({
                                name: sheetName,
                                rows: rows,
                                sourceFiles: [file.name]
                            });
                        }

                        rows.forEach(row => {
                            const mudurluk = row['M√ºd√ºrl√ºk'] || row['M√ºd√ºrluk'] || row['Mudurluk'];
                            const hizmet = row['Hizmet'] || row['Hizmet Ba≈ülƒ±ƒüƒ±'] || row['Hizmet Basligi'];
                            const tur = row['T√ºr'] || row['Tur'];
                            let tarih = null;
                            const sonTarih = row['Son Tarih'];
                            if (sonTarih) {
                                if (typeof sonTarih === 'number') {
                                    tarih = new Date((sonTarih - 25569) * 86400 * 1000);
                                } else if (typeof sonTarih === 'string') {
                                    const parts = sonTarih.split('.');
                                    if (parts.length === 3) tarih = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            }
                            const deger = parseFloat(row['Deƒüer'] || row['Deger']) || 0;
                            // Veri Aralƒ±ƒüƒ±: Birden fazla s√ºtun adƒ± ve T√ºrk√ße karakter desteƒüi
                            const veriAraligiRaw = row['Veri Aralƒ±ƒüƒ±'] || row['Veri Araligi'] || row['VeriAraligi'] || row['veri_araligi'] || '';
                            const veriAraligi = veriAraligiRaw.toString().trim().toLocaleUpperCase('tr-TR');

                            // ƒ∞lk Tarih ve Sorumlu bilgisini de al
                            const ilkTarih = row['ƒ∞lk Tarih'] || row['Ilk Tarih'] || null;
                            const veriSorumlusu = row['Veri Sorumlusu'] || row['Sorumlu'] || '';

                            if (mudurluk && hizmet && tur && tarih && !isNaN(tarih)) {
                                rawData.push({
                                    mudurluk, hizmet, tur, deger, tarih: tarih.toISOString(),
                                    lokasyon: row['Lokasyon'] || row['lokasyon'] || 'ƒ∞stanbul Geneli',
                                    veriAraligi: veriAraligi || 'BGG',
                                    ilkTarih,
                                    veriSorumlusu,
                                    _sheetName: sheetName // Kaynak sayfa adƒ±nƒ± sakla
                                });
                                // Track max date for data period display
                                if (!maxDate || tarih > maxDate) maxDate = tarih;
                            }
                        });
                    });
                }

                // NOT: sessionStorage/localStorage 5MB sƒ±nƒ±rƒ± var - KULLANMA!
                // B√ºy√ºk veriler SADECE IndexedDB'ye kaydedilir

                // IndexedDB'ye kaydet (5MB sƒ±nƒ±rƒ± yok, sayfa yenilemesinde kaybolmaz)
                try {
                    await saveToIndexedDB('hizmet_rawdata', rawData);
                    await saveToIndexedDB('hizmet_sheets', allSheets);
                    console.log('üíæ IndexedDB\'ye kaydedildi:', rawData.length, 'kayƒ±t,', allSheets.length, 'sayfa');
                } catch (dbErr) {
                    console.warn('IndexedDB kayƒ±t hatasƒ±:', dbErr.message);
                }

                // Veri aralƒ±ƒüƒ± daƒüƒ±lƒ±mƒ±nƒ± g√∂ster (debug)
                const bggCount = rawData.filter(r => r.veriAraligi === 'BGG').length;
                const kumCount = rawData.filter(r => r.veriAraligi === 'K√úM√úLATƒ∞F').length;
                const aylikCount = rawData.filter(r => r.veriAraligi === 'AYLIK').length;
                console.log('üìä Veri Aralƒ±ƒüƒ± Daƒüƒ±lƒ±mƒ±:', bggCount, 'BGG,', kumCount, 'K√úM√úLATƒ∞F,', aylikCount, 'AYLIK');
                console.log('üìã Toplam sayfa sayƒ±sƒ±:', allSheets.length);

                document.getElementById('hizmet-status').textContent = '‚úì ' + rawData.length + ' kayƒ±t, ' + allSheets.length + ' sayfa y√ºklendi (' + files.length + ' dosya)';
                document.getElementById('hizmet-upload-label').style.borderColor = '#3b82f6';
                document.getElementById('hizmet-upload-label').style.background = '#eff6ff';

                // ƒ∞ndir butonunu g√∂ster
                document.getElementById('download-merged-data').style.display = 'block';

                // Update data period display on main page
                if (maxDate) {
                    const periodStr = monthNames[maxDate.getMonth()] + ' ' + maxDate.getFullYear();
                    document.getElementById('data-period').textContent = periodStr;
                    sessionStorage.setItem('temp_data_period', periodStr);
                    localStorage.setItem('temp_data_period', periodStr);

                    // IndexedDB'ye de kaydet
                    try {
                        await saveToIndexedDB('data_period', periodStr);
                    } catch (e) { }

                    // Gallery.js i√ßin YYYY-MM formatƒ±nda kaydet (otomatik rapor tarihi)
                    const autoMonth = `${maxDate.getFullYear()}-${String(maxDate.getMonth() + 1).padStart(2, '0')}`;
                    localStorage.setItem('auto_report_month', autoMonth);
                    console.log('üìÖ auto_report_month kaydedildi:', autoMonth);
                }
            } catch (err) {
                document.getElementById('hizmet-status').textContent = 'Hata: ' + err.message;
            }
        };

        document.getElementById('gosterge-file').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const buffer = await file.arrayBuffer();
                const wb = XLSX.read(buffer, { type: 'array' });
                const sheet = wb.Sheets['Sistem_Tanimlari'];
                if (!sheet) throw new Error('Sistem_Tanimlari sayfasƒ± bulunamadƒ±');

                const rows = XLSX.utils.sheet_to_json(sheet);
                const dirMap = new Map();
                const modMap = new Map();
                const goalMap = new Map();
                const actMap = new Map();
                const indicators = [];

                rows.forEach(r => {
                    if (r.DirectorateID && !dirMap.has(r.DirectorateID))
                        dirMap.set(r.DirectorateID, { id: String(r.DirectorateID), name: r.DirectorateName });
                    if (r.ModelID && !modMap.has(r.ModelID))
                        modMap.set(r.ModelID, { id: String(r.ModelID), directorateId: String(r.DirectorateID), name: r.ModelName });
                    if (r.GoalID && !goalMap.has(r.GoalID))
                        goalMap.set(r.GoalID, { id: String(r.GoalID), modelId: String(r.ModelID), name: r.GoalName });
                    if (r.ActionID && !actMap.has(r.ActionID))
                        actMap.set(r.ActionID, { id: String(r.ActionID), goalId: String(r.GoalID), name: r.ActionName });
                    if (r.GostergeID) {
                        let ind = indicators.find(i => i.id == r.GostergeID);
                        if (!ind) {
                            ind = {
                                id: String(r.GostergeID), modelId: String(r.ModelID), directorateId: String(r.DirectorateID),
                                goalId: String(r.GoalID), actionId: String(r.ActionID), name: r.GostergeAdi,
                                type: r.GostergeTipi || 'birim', targetYear: r.HedefYili || 2025,
                                targets: { q1: r.H_Q1 || 0, q2: r.H_Q2 || 0, q3: r.H_Q3 || 0, q4: r.H_Q4 || 0 },
                                selections: []
                            };
                            indicators.push(ind);
                        }
                        if (r.SrcMud && r.SrcHiz && r.SrcTur) {
                            const plans = [];
                            for (let i = 1; i <= 12; i++) plans.push(r['P_' + i] || null);
                            const useForecastVal = (r.TahminAktif !== undefined) ? r.TahminAktif : 1;
                            ind.selections.push({ mudurluk: r.SrcMud, hizmet: r.SrcHiz, tur: r.SrcTur, plans, useForecast: useForecastVal == 1 });
                        }
                    }
                });

                const data = {
                    directorates: Array.from(dirMap.values()),
                    models: Array.from(modMap.values()),
                    goals: Array.from(goalMap.values()),
                    actions: Array.from(actMap.values())
                };
                sessionStorage.setItem('temp_strateji_indicators', JSON.stringify({ data, indicators }));
                document.getElementById('gosterge-status').textContent = '‚úì ' + indicators.length + ' g√∂sterge y√ºklendi';
                document.getElementById('gosterge-upload-label').style.borderColor = '#10b981';
                document.getElementById('gosterge-upload-label').style.background = '#ecfdf5';
            } catch (err) {
                document.getElementById('gosterge-status').textContent = 'Hata: ' + err.message;
            }
        };

        document.getElementById('clear-temp-data').onclick = async () => {
            // Clear all temporary data and browser storage
            sessionStorage.clear();
            localStorage.clear();

            // IndexedDB'yi de temizle
            try {
                await clearIndexedDB();
                console.log('üóëÔ∏è IndexedDB temizlendi');
            } catch (e) {
                console.warn('IndexedDB temizleme hatasƒ±:', e.message);
            }

            tempModal.remove();
            // Reload page to restore default data
            location.reload();
        };

        // ƒ∞ndir butonu - T√ºm sayfalarƒ± birle≈üik Excel olarak indir
        document.getElementById('download-merged-data').onclick = async () => {
            try {
                // √ñnce IndexedDB'den dene, yoksa bellekteki veriyi kullan
                let sheetsData = await loadFromIndexedDB('hizmet_sheets');

                if (!sheetsData || sheetsData.length === 0) {
                    alert('ƒ∞ndirilecek veri yok. √ñnce Excel dosyasƒ± y√ºkleyin.');
                    return;
                }

                // Yeni Excel √ßalƒ±≈üma kitabƒ± olu≈ütur
                const wb = XLSX.utils.book_new();

                sheetsData.forEach(sheet => {
                    // Excel sayfa adƒ± max 31 karakter
                    const safeName = sheet.name.substring(0, 31).replace(/[\[\]\*\?\/\\:]/g, '_');
                    const ws = XLSX.utils.json_to_sheet(sheet.rows);
                    XLSX.utils.book_append_sheet(wb, ws, safeName);
                });

                // Dosya adƒ±: birlesik_veri_YYYYMMDD.xlsx
                const today = new Date();
                const dateStr = today.getFullYear() +
                    String(today.getMonth() + 1).padStart(2, '0') +
                    String(today.getDate()).padStart(2, '0');

                XLSX.writeFile(wb, `birlesik_veri_${dateStr}.xlsx`);
                console.log('üì• Birle≈üik Excel indirildi:', sheetsData.length, 'sayfa');
            } catch (err) {
                alert('ƒ∞ndirme hatasƒ±: ' + err.message);
                console.error('ƒ∞ndirme hatasƒ±:', err);
            }
        };

        document.getElementById('apply-temp-data').onclick = async () => {
            try {
                const rawData = await loadFromIndexedDB('hizmet_rawdata');
                const indicators = sessionStorage.getItem('temp_strateji_indicators');

                if ((rawData && rawData.length > 0) || indicators) {
                    alert('Ge√ßici veriler kaydedildi!');
                } else {
                    alert('Hen√ºz veri y√ºklenmedi.');
                }
            } catch (e) {
                alert('Hen√ºz veri y√ºklenmedi.');
            }
            tempModal.remove();
        };
    });

    // Hizmet Kartlarƒ± butonu i√ßin click handler - veri d√∂nemini localStorage'a kaydet
    const hizmetKartlariBtn = document.getElementById('hizmet-kartlari-btn');
    if (hizmetKartlariBtn) {
        hizmetKartlariBtn.addEventListener('click', function (e) {
            e.preventDefault(); // √ñnce navigate etmeyi durdur

            const periodEl = document.getElementById('data-period');
            const periodText = periodEl.textContent.trim(); // "Ekim 2025"

            // Ay ismini sayƒ±ya √ßevir
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const parts = periodText.split(' ');
            if (parts.length === 2) {
                const monthIndex = monthNames.indexOf(parts[0]);
                const year = parts[1];
                if (monthIndex >= 0) {
                    const monthStr = String(monthIndex + 1).padStart(2, '0');
                    localStorage.setItem('auto_report_month', `${year}-${monthStr}`);
                    console.log('üìÖ Otomatik rapor tarihi kaydedildi:', `${year}-${monthStr}`);
                }
            }

            // ≈ûimdi navigate et - localStorage ile autoGenerate flag'i at
            localStorage.setItem('gallery_auto_generate', 'true');
            window.location.href = 'gallery.html';
        });
    }

    // Sayfa y√ºklendiƒüinde veri d√∂nemini g√∂ster
    async function initDataPeriod() {
        const periodEl = document.getElementById('data-period');

        // √ñnce localStorage/sessionStorage kontrol et
        const savedPeriod = localStorage.getItem('temp_data_period') || sessionStorage.getItem('temp_data_period');
        if (savedPeriod) {
            periodEl.textContent = savedPeriod;
            return;
        }

        // Yoksa varsayƒ±lan veri.xlsx'den y√ºkle
        try {
            const response = await fetch('hizmet-verileri/veri.xlsx');
            if (!response.ok) throw new Error('Dosya bulunamadƒ±');
            const buffer = await response.arrayBuffer();
            const wb = XLSX.read(buffer, { type: 'array', cellDates: true });

            let maxDate = null;
            const hizSheet = wb.Sheets['Hizmetler'];
            if (hizSheet) {
                const rows = XLSX.utils.sheet_to_json(hizSheet, { cellDates: true });
                rows.forEach(row => {
                    const sonTarih = row['Son Tarih'];
                    if (sonTarih instanceof Date && !isNaN(sonTarih)) {
                        if (!maxDate || sonTarih > maxDate) maxDate = sonTarih;
                    } else if (typeof sonTarih === 'number' && sonTarih > 25569) {
                        const d = new Date(Math.round((sonTarih - 25569) * 86400 * 1000));
                        if (!maxDate || d > maxDate) maxDate = d;
                    }
                });
            }

            if (maxDate) {
                const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                    'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
                const periodStr = monthNames[maxDate.getMonth()] + ' ' + maxDate.getFullYear();
                periodEl.textContent = periodStr;

                // auto_report_month'u da ayarla
                const autoMonth = `${maxDate.getFullYear()}-${String(maxDate.getMonth() + 1).padStart(2, '0')}`;
                localStorage.setItem('auto_report_month', autoMonth);
                console.log('üìÖ Varsayƒ±lan veri d√∂nemi y√ºklendi:', periodStr);
            } else {
                periodEl.textContent = 'Veri yok';
            }
        } catch (err) {
            console.log('Varsayƒ±lan veri y√ºklenemedi:', err.message);
            periodEl.textContent = 'Veri yok';
        }
    }

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
    initDataPeriod();

    // ==================== VERƒ∞ Gƒ∞Rƒ∞≈û TASLAK OLU≈ûTURUCU ==================== //

    const ISTANBUL_ILCELERI = [
        'Adalar', 'Arnavutk√∂y', 'Ata≈üehir', 'Avcƒ±lar', 'Baƒücƒ±lar', 'Bah√ßelievler', 'Bakƒ±rk√∂y',
        'Ba≈üak≈üehir', 'Bayrampa≈üa', 'Be≈üikta≈ü', 'Beykoz', 'Beylikd√ºz√º', 'Beyoƒülu', 'B√ºy√ºk√ßekmece',
        '√áatalca', '√áekmek√∂y', 'Esenler', 'Esenyurt', 'Ey√ºpsultan', 'Fatih', 'Gaziosmanpa≈üa',
        'G√ºng√∂ren', 'Kadƒ±k√∂y', 'Kaƒüƒ±thane', 'Kartal', 'K√º√ß√ºk√ßekmece', 'Maltepe', 'Pendik',
        'Sancaktepe', 'Sarƒ±yer', 'Silivri', 'Sultanbeyli', 'Sultangazi', '≈ûile', '≈ûi≈üli',
        'Tuzla', '√úmraniye', '√úsk√ºdar', 'Zeytinburnu', 'Diƒüer'
    ];

    let tplAllData = []; // Veri.xlsx'den y√ºklenen t√ºm veriler

    async function loadTplData() {
        if (tplAllData.length > 0) return;

        try {
            // √ñnce sessionStorage'dan ge√ßici veri kontrol√º
            const tempRawData = sessionStorage.getItem('temp_strateji_rawdata');
            let allRows = [];

            if (tempRawData) {
                // Ge√ßici veri var - onu kullan
                const parsedData = JSON.parse(tempRawData);
                allRows = parsedData;
                console.log('üìä Ge√ßici veri kullanƒ±lƒ±yor:', allRows.length, 'kayƒ±t');
            } else {
                // Ge√ßici veri yok - varsayƒ±lan Excel'den y√ºkle
                const response = await fetch('hizmet-verileri/veri.xlsx');
                if (!response.ok) throw new Error('Dosya bulunamadƒ±');
                const buffer = await response.arrayBuffer();
                const wb = XLSX.read(buffer, { type: 'array' });

                wb.SheetNames.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                    allRows = allRows.concat(rows);
                });
                console.log('üìä Varsayƒ±lan veri y√ºklendi:', allRows.length, 'kayƒ±t');
            }

            // Verileri parse et - hem b√ºy√ºk harfli hem k√º√ß√ºk harfli key'leri destekle
            allRows.forEach(row => {
                // Ge√ßici veri k√º√ß√ºk harfli key'ler kullanƒ±yor, Excel b√ºy√ºk harfli
                const mudurluk = row['M√ºd√ºrl√ºk'] || row['M√ºd√ºrluk'] || row['Mudurluk'] || row['mudurluk'];
                const hizmet = row['Hizmet'] || row['Hizmet Ba≈ülƒ±ƒüƒ±'] || row['Hizmet Basligi'] || row['hizmet'];
                const tur = row['T√ºr'] || row['Tur'] || row['tur'];
                const veriAraligi = row['Veri Aralƒ±ƒüƒ±'] || row['Veri Araligi'] || row['veriAraligi'];
                const ilkTarih = row['ƒ∞lk Tarih'] || row['Ilk Tarih'] || row['ilkTarih'] || null;
                const veriSorumlusu = row['Veri Sorumlusu'] || row['Sorumlu'] || row['veriSorumlusu'] || '';
                const lokasyon = row['Lokasyon'] || row['ƒ∞l√ße'] || row['lokasyon'] || '';

                if (mudurluk && hizmet && tur) {
                    tplAllData.push({
                        mudurluk,
                        hizmet,
                        tur,
                        veriAraligi,
                        ilkTarih,
                        veriSorumlusu,
                        lokasyon
                    });
                }
            });

            console.log('üìä Template veri hazƒ±r:', tplAllData.length, 'kayƒ±t');
        } catch (err) {
            console.error('Veri y√ºklenemedi:', err);
        }
    }

    async function openTemplateWizard() {
        document.getElementById('template-modal').style.display = 'flex';
        // Her a√ßƒ±lƒ±≈üta veriyi yeniden y√ºkle (ge√ßici veri deƒüi≈ümi≈ü olabilir)
        tplAllData = [];
        await loadTplData();
        populateTplMudurlukler();
        showTemplateStep(1);
    }

    function closeTemplateWizard() {
        document.getElementById('template-modal').style.display = 'none';
    }

    function showTemplateStep(step) {
        document.getElementById('template-step-1').style.display = step === 1 ? 'block' : 'none';
        document.getElementById('template-step-2').style.display = step === 2 ? 'block' : 'none';

        if (step === 2) {
            // Step 2'ye ge√ßerken mode'a g√∂re UI'ƒ± g√ºncelle
            const mode = document.querySelector('input[name="tpl-mode"]:checked').value;
            document.getElementById('single-mode-protection').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('bulk-mode-protection').style.display = mode === 'bulk' ? 'block' : 'none';
            document.getElementById('single-mode-bgg-date').style.display = mode === 'single' ? 'block' : 'none';

            if (mode === 'bulk') {
                // Toplu modda: Hizmet-T√ºr listesini olu≈ütur
                populateBulkHizmetTurTable();
            }
        }
    }

    function handleModeChange() {
        const mode = document.querySelector('input[name="tpl-mode"]:checked').value;
        const singleContent = document.getElementById('single-mode-content');
        const bulkMudurlukSelect = document.getElementById('bulk-mode-mudurluk-select');

        if (mode === 'single') {
            singleContent.style.display = 'block';
            bulkMudurlukSelect.style.display = 'none';
        } else {
            singleContent.style.display = 'none';
            bulkMudurlukSelect.style.display = 'block';
            populateBulkMudurlukList();
        }
    }

    function populateBulkMudurlukList() {
        const container = document.getElementById('bulk-mudurluk-list');
        const mudurlukler = [...new Set(tplAllData.map(d => d.mudurluk))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'tr'));

        container.innerHTML = mudurlukler.map(m => `
            <label style="display: flex; align-items: center; gap: 6px; padding: 6px; background: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" class="bulk-mudurluk-cb" value="${m}" checked>
                <span>${m}</span>
            </label>
        `).join('');
    }

    function toggleAllMudurlukler(checked) {
        document.querySelectorAll('.bulk-mudurluk-cb').forEach(cb => cb.checked = checked);
    }

    function handleBulkProtectionCheckbox() {
        const checked = document.getElementById('bulk-protection-checkbox').checked;

        // ≈ûifre input alanƒ±nƒ± g√∂ster/gizle
        document.getElementById('bulk-kitap-sifre-container').style.display = checked ? 'block' : 'none';

        // K-L ≈ûifresi s√ºtun ba≈ülƒ±ƒüƒ±nƒ± g√∂ster/gizle
        document.getElementById('bulk-sifre-header').style.display = checked ? 'table-cell' : 'none';

        // Tablo h√ºcrelerini g√ºncelle (K-L ≈üifresi s√ºtunu)
        document.querySelectorAll('.bulk-sifre-cell').forEach(cell => {
            cell.style.display = checked ? 'table-cell' : 'none';
        });
    }

    function populateBulkHizmetTurTable() {
        const tbody = document.getElementById('bulk-hizmet-tur-tbody');

        // Se√ßili m√ºd√ºrl√ºkleri al
        const selectedMudurlukler = Array.from(document.querySelectorAll('.bulk-mudurluk-cb:checked')).map(cb => cb.value);

        if (selectedMudurlukler.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #64748b;">L√ºtfen en az bir m√ºd√ºrl√ºk se√ßin</td></tr>';
            return;
        }

        // Her m√ºd√ºrl√ºk i√ßin hizmet-t√ºr kombinasyonlarƒ±nƒ± topla
        const hizmetTurList = [];
        const seen = new Set();

        tplAllData.forEach(d => {
            if (!selectedMudurlukler.includes(d.mudurluk)) return;

            const key = `${d.mudurluk}|||${d.hizmet}|||${d.tur}`;
            if (seen.has(key)) return;
            seen.add(key);

            // BGG tarihini bul - √∂nce BGG satƒ±rlarƒ±ndan, yoksa herhangi bir ilkTarih'i al
            const matchingRows = tplAllData.filter(x => x.mudurluk === d.mudurluk && x.hizmet === d.hizmet && x.tur === d.tur);

            // BGG satƒ±rlarƒ±ndan ilk tarihi bul
            let bggDate = matchingRows
                .filter(x => (x.veriAraligi === 'BGG' || x.veriAraligi === 'bgg') && x.ilkTarih)
                .map(x => x.ilkTarih)
                .sort()[0];

            // BGG bulunamadƒ±ysa herhangi bir ilkTarih al
            if (!bggDate) {
                bggDate = matchingRows.filter(x => x.ilkTarih).map(x => x.ilkTarih)[0] || '';
            }

            // Sorumluyu bul (ilk bulunan deƒüeri al)
            const sorumlu = matchingRows.find(x => x.veriSorumlusu)?.veriSorumlusu || '';

            // ƒ∞l√ße detayƒ±nƒ± belirle (40 il√ßeden herhangi biri varsa il√ße detayƒ± var)
            const lokasyonlar = tplAllData
                .filter(x => x.mudurluk === d.mudurluk && x.hizmet === d.hizmet && x.tur === d.tur && x.lokasyon)
                .map(x => x.lokasyon);
            const hasIlceDetail = lokasyonlar.some(l => l !== 'ƒ∞stanbul Geneli');

            hizmetTurList.push({
                mudurluk: d.mudurluk,
                hizmet: d.hizmet,
                tur: d.tur,
                bggDate,
                sorumlu,
                hasIlceDetail
            });
        });

        // M√ºd√ºrl√ºk > Hizmet > T√ºr olarak sƒ±rala
        hizmetTurList.sort((a, b) => {
            if (a.mudurluk !== b.mudurluk) return a.mudurluk.localeCompare(b.mudurluk, 'tr');
            if (a.hizmet !== b.hizmet) return a.hizmet.localeCompare(b.hizmet, 'tr');
            return a.tur.localeCompare(b.tur, 'tr');
        });

        // ≈ûifre korumasƒ± durumu
        const showSifre = document.getElementById('bulk-protection-checkbox').checked;

        tbody.innerHTML = hizmetTurList.map((item, idx) => {
            // BGG tarihini Date'e √ßevirip input formatƒ±na d√∂n√º≈üt√ºr
            const bggDateObj = item.bggDate ? parseTurkishDate(item.bggDate) : null;
            const bggDateValue = bggDateObj ? formatDateForInput(bggDateObj) : '';

            return `
            <tr>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0; font-size: 10px;">${item.mudurluk}</td>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0; font-weight: 500;">${item.hizmet}</td>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">${item.tur}</td>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">
                    <select class="bulk-ilce-detay" data-key="${item.mudurluk}|||${item.hizmet}|||${item.tur}"
                        style="width: 100%; padding: 3px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 10px;">
                        <option value="ilce" ${item.hasIlceDetail ? 'selected' : ''}>40 ƒ∞l√ße</option>
                        <option value="geneli" ${!item.hasIlceDetail ? 'selected' : ''}>ƒ∞st. Geneli</option>
                    </select>
                </td>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">
                    <input type="date" class="bulk-bgg-date" data-key="${item.mudurluk}|||${item.hizmet}|||${item.tur}" 
                        value="${bggDateValue}"
                        style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 10px;">
                </td>
                <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">
                    <input type="text" class="bulk-hizmet-tur-sorumlu" data-key="${item.mudurluk}|||${item.hizmet}|||${item.tur}" 
                        value="${item.sorumlu || ''}" placeholder="Sorumlu"
                        style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px;">
                </td>
                <td class="bulk-sifre-cell" style="padding: 6px; border-bottom: 1px solid #e2e8f0; display: ${showSifre ? 'table-cell' : 'none'};">
                    <input type="text" class="bulk-hizmet-tur-sifre" data-key="${item.mudurluk}|||${item.hizmet}|||${item.tur}" placeholder="≈ûifre"
                        style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px;">
                </td>
            </tr>
        `}).join('');
    }

    // Eski populateBulkTurTable fonksiyonunu kaldƒ±r

    function populateTplMudurlukler() {
        const select = document.getElementById('tpl-mudurluk');
        const mudurlukler = [...new Set(tplAllData.map(d => d.mudurluk))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'tr'));
        select.innerHTML = '<option value="">Se√ßiniz...</option>' +
            mudurlukler.map(m => `<option value="${m}">${m}</option>`).join('') +
            '<option value="__NEW__" style="color: #10b981; font-weight: 600;">‚ûï Yeni M√ºd√ºrl√ºk Ekle...</option>';

        // Container'ƒ± gizle
        document.getElementById('tpl-mudurluk-new-container').style.display = 'none';
        document.getElementById('tpl-mudurluk-new').value = '';
    }

    function handleMudurlukChange() {
        const select = document.getElementById('tpl-mudurluk');
        const newContainer = document.getElementById('tpl-mudurluk-new-container');

        if (select.value === '__NEW__') {
            newContainer.style.display = 'block';
            document.getElementById('tpl-mudurluk-new').focus();
            // Hizmet dropdown'ƒ±nƒ± "Yeni Ekle" modunda a√ß
            updateTplHizmetlerForNew();
        } else {
            newContainer.style.display = 'none';
            updateTplHizmetler();
        }
    }

    function updateTplHizmetler() {
        const mudurluk = document.getElementById('tpl-mudurluk').value;
        const select = document.getElementById('tpl-hizmet');
        const newContainer = document.getElementById('tpl-hizmet-new-container');
        newContainer.style.display = 'none';

        if (!mudurluk || mudurluk === '__NEW__') {
            select.innerHTML = '<option value="">√ñnce m√ºd√ºrl√ºk se√ßin...</option>';
            document.getElementById('tpl-turler').innerHTML = '<p style="color: #64748b; font-size: 12px;">√ñnce hizmet se√ßin...</p>';
            return;
        }

        const hizmetler = [...new Set(tplAllData.filter(d => d.mudurluk === mudurluk).map(d => d.hizmet))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'tr'));
        select.innerHTML = '<option value="">Se√ßiniz...</option>' +
            hizmetler.map(h => `<option value="${h}">${h}</option>`).join('') +
            '<option value="__NEW__" style="color: #10b981; font-weight: 600;">‚ûï Yeni Hizmet Ekle...</option>';
        document.getElementById('tpl-turler').innerHTML = '<p style="color: #64748b; font-size: 12px;">√ñnce hizmet se√ßin...</p>';
    }

    function updateTplHizmetlerForNew() {
        const select = document.getElementById('tpl-hizmet');
        const newContainer = document.getElementById('tpl-hizmet-new-container');

        select.innerHTML = '<option value="__NEW__" selected>‚ûï Yeni Hizmet Girin</option>';
        newContainer.style.display = 'block';
        document.getElementById('tpl-hizmet-new').value = '';

        // T√ºr alanƒ±nƒ± da yeni modda a√ß
        updateTplTurlerForNew();
    }

    function handleHizmetChange() {
        const select = document.getElementById('tpl-hizmet');
        const newContainer = document.getElementById('tpl-hizmet-new-container');

        if (select.value === '__NEW__') {
            newContainer.style.display = 'block';
            document.getElementById('tpl-hizmet-new').focus();
            updateTplTurlerForNew();
        } else {
            newContainer.style.display = 'none';
            updateTplTurler();
        }
    }

    function updateTplTurler() {
        const mudurluk = document.getElementById('tpl-mudurluk').value;
        const hizmet = document.getElementById('tpl-hizmet').value;
        const container = document.getElementById('tpl-turler');

        if (!hizmet || hizmet === '__NEW__') {
            container.innerHTML = '<p style="color: #64748b; font-size: 12px;">√ñnce hizmet se√ßin...</p>';
            return;
        }

        const turler = [...new Set(tplAllData.filter(d => d.mudurluk === mudurluk && d.hizmet === hizmet).map(d => d.tur))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'tr'));

        if (turler.length === 0) {
            container.innerHTML = '<p style="color: #64748b; font-size: 12px;">Bu hizmet i√ßin mevcut t√ºr yok. A≈üaƒüƒ±dan yeni t√ºr ekleyebilirsiniz.</p>';
            return;
        }

        container.innerHTML = turler.map((t, idx) => `
            <div class="tur-item" style="padding: 8px; margin-bottom: 6px; background: white; border: 1px solid #e2e8f0; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <input type="checkbox" id="tur-cb-${idx}" value="${t}" checked style="width: 16px; height: 16px;">
                    <label for="tur-cb-${idx}" style="font-weight: 500; cursor: pointer;">${t}</label>
                </div>
                <div style="display: flex; gap: 6px; padding-left: 24px;">
                    <input type="text" class="tur-sorumlu" data-tur="${t}" placeholder="Sorumlu adƒ±"
                        style="flex: 1; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px;">
                    <input type="text" class="tur-sifre" data-tur="${t}" placeholder="≈ûifre"
                        style="width: 80px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px;">
                </div>
            </div>
        `).join('');
    }

    function updateTplTurlerForNew() {
        const container = document.getElementById('tpl-turler');
        container.innerHTML = '<p style="color: #10b981; font-size: 12px;">‚ú® Yeni hizmet i√ßin a≈üaƒüƒ±dan t√ºr(ler) ekleyin.</p>';
    }

    function addNewTur() {
        const turInput = document.getElementById('tpl-tur-new');
        const sorumluInput = document.getElementById('tpl-tur-new-sorumlu');
        const sifreInput = document.getElementById('tpl-tur-new-sifre');

        const turName = turInput.value.trim();
        const sorumlu = sorumluInput.value.trim();
        const sifre = sifreInput.value.trim();

        if (!turName) {
            alert('L√ºtfen t√ºr adƒ± girin!');
            return;
        }

        if (!sorumlu || !sifre) {
            alert('L√ºtfen sorumlu ve ≈üifre bilgilerini girin!');
            return;
        }

        const container = document.getElementById('tpl-turler');

        // Eƒüer placeholder mesajƒ± varsa temizle
        if (container.querySelector('p')) {
            container.innerHTML = '';
        }

        // Aynƒ± t√ºr zaten var mƒ± kontrol et
        const existingItems = container.querySelectorAll('.tur-item');
        for (const item of existingItems) {
            const cb = item.querySelector('input[type="checkbox"]');
            if (cb && cb.value.toLowerCase() === turName.toLowerCase()) {
                alert('Bu t√ºr zaten mevcut!');
                turInput.value = '';
                return;
            }
        }

        // Yeni t√ºr ekle
        const idx = existingItems.length;
        const div = document.createElement('div');
        div.className = 'tur-item';
        div.style.cssText = 'padding: 8px; margin-bottom: 6px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 6px;';
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                <input type="checkbox" id="tur-cb-new-${idx}" value="${turName}" checked style="width: 16px; height: 16px;">
                <label for="tur-cb-new-${idx}" style="font-weight: 500; cursor: pointer; color: #166534;">${turName}</label>
                <span style="font-size: 10px; color: #64748b;">(yeni)</span>
            </div>
            <div style="display: flex; gap: 6px; padding-left: 24px;">
                <input type="text" class="tur-sorumlu" data-tur="${turName}" value="${sorumlu}" placeholder="Sorumlu adƒ±"
                    style="flex: 1; padding: 6px 8px; border: 1px solid #10b981; border-radius: 4px; font-size: 11px; background: white;">
                <input type="text" class="tur-sifre" data-tur="${turName}" value="${sifre}" placeholder="≈ûifre"
                    style="width: 80px; padding: 6px 8px; border: 1px solid #10b981; border-radius: 4px; font-size: 11px; background: white;">
            </div>
        `;
        container.appendChild(div);

        // Inputlarƒ± temizle
        turInput.value = '';
        sorumluInput.value = '';
        sifreInput.value = '';
        turInput.focus();
    }

    function getLastDayOfMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    function formatDate(date) {
        return `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
    }

    function parseTurkishDate(dateStr) {
        // "1.1.2025" formatƒ±ndan veya Excel serial numarasƒ±ndan Date objesine √ßevir
        if (!dateStr) return null;

        // Eƒüer sayƒ±sal ise (Excel serial date), d√∂n√º≈üt√ºr
        if (typeof dateStr === 'number') {
            // Excel serial tarih: 1 Ocak 1900 = 1, her g√ºn +1
            const excelEpoch = new Date(1899, 11, 30); // Excel'in ba≈ülangƒ±√ß tarihi
            return new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000);
        }

        // String formattaysa parse et
        const parts = String(dateStr).split('.');
        if (parts.length !== 3) return null;
        return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
    }

    // Tarihi HTML date input formatƒ±na (yyyy-mm-dd) √ßevir
    function formatDateForInput(date) {
        if (!date || !(date instanceof Date) || isNaN(date)) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Excel ≈üifre hash fonksiyonu (legacy Excel format)
    function excelPasswordHash(password) {
        if (!password) return '';
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
            let charCode = password.charCodeAt(i);
            hash ^= ((charCode << (i + 1)) | (charCode >> (15 - i))) & 0x7FFF;
        }
        hash ^= password.length;
        hash ^= 0xCE4B;
        return hash.toString(16).toUpperCase().padStart(4, '0');
    }

    // Toplu Excel olu≈üturma fonksiyonu
    async function generateBulkExcelFiles() {
        const year = parseInt(document.getElementById('tpl-year').value);
        const withProtection = document.getElementById('bulk-protection-checkbox').checked;

        // Se√ßili m√ºd√ºrl√ºkleri al
        const selectedMudurlukler = Array.from(document.querySelectorAll('.bulk-mudurluk-cb:checked')).map(cb => cb.value);

        if (selectedMudurlukler.length === 0) {
            alert('L√ºtfen en az bir m√ºd√ºrl√ºk se√ßin!');
            showTemplateStep(1);
            return;
        }

        // Hizmet-T√ºr kombinasyonlarƒ±nƒ± ve ayarlarƒ±nƒ± tabloda topla
        const hizmetTurData = {}; // key -> { bggDate, sorumlu, sifre, ilceDetay }

        // Kitap ≈üifresi kontrol√º
        const kitapSifre = withProtection ? document.getElementById('bulk-kitap-sifre').value.trim() : '';
        if (withProtection && !kitapSifre) {
            alert('L√ºtfen √ßalƒ±≈üma kitabƒ± ≈üifresini girin!');
            return;
        }

        // Tablo verilerini al - her satƒ±r i√ßin bgg, sorumlu, il√ße detayƒ± ve (opsiyonel) ≈üifre
        const bggInputs = document.querySelectorAll('.bulk-bgg-date');
        const sorumluInputs = document.querySelectorAll('.bulk-hizmet-tur-sorumlu');
        const sifreInputs = document.querySelectorAll('.bulk-hizmet-tur-sifre');
        const ilceSelects = document.querySelectorAll('.bulk-ilce-detay');

        bggInputs.forEach((input, idx) => {
            const key = input.dataset.key;
            const sorumlu = sorumluInputs[idx].value.trim();
            const sifre = withProtection ? sifreInputs[idx].value.trim() : '';
            const ilceDetay = ilceSelects[idx].value; // 'ilce' veya 'geneli'

            // Date input deƒüerini (yyyy-mm-dd) parsela
            let bggDate = null;
            if (input.value) {
                const parts = input.value.split('-');
                bggDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }

            hizmetTurData[key] = {
                bggDate,
                sorumlu,
                sifre: sifre || null,
                kitapSifre,
                ilceDetay
            };
        });

        // Hizmet bazƒ±nda grupla
        const allHizmetler = {};
        Object.keys(hizmetTurData).forEach(key => {
            const [mudurluk, hizmet, tur] = key.split('|||');
            if (!selectedMudurlukler.includes(mudurluk)) return;

            if (!allHizmetler[mudurluk]) allHizmetler[mudurluk] = {};
            if (!allHizmetler[mudurluk][hizmet]) allHizmetler[mudurluk][hizmet] = [];

            allHizmetler[mudurluk][hizmet].push({
                tur,
                ...hizmetTurData[key]
            });
        });

        // ZIP olu≈ütur
        const zip = new JSZip();
        let fileCount = 0;

        // Her hizmet i√ßin Excel olu≈ütur
        for (const mudurluk of Object.keys(allHizmetler)) {
            for (const hizmet of Object.keys(allHizmetler[mudurluk])) {
                const turlerData = allHizmetler[mudurluk][hizmet];

                const wb = XLSX.utils.book_new();
                const turlerForProtection = [];

                turlerData.forEach(turData => {
                    const rows = [];
                    const bggStartDate = turData.bggDate || new Date(year, 0, 1);

                    // Her t√ºr i√ßin il√ße detayƒ±na g√∂re lokasyonlarƒ± belirle
                    const locations = turData.ilceDetay === 'ilce' ? ISTANBUL_ILCELERI : ['ƒ∞stanbul Geneli'];

                    for (let month = 0; month < 12; month++) {
                        const monthLastDay = getLastDayOfMonth(year, month);
                        const yearStart = new Date(year, 0, 1);
                        const monthStart = new Date(year, month, 1);
                        const monthEnd = new Date(year, month, monthLastDay);

                        ['Aylƒ±k', 'K√ºm√ºlatif', 'BGG'].forEach(aralik => {
                            locations.forEach(lokasyon => {
                                let ilkTarih, sonTarih;

                                if (aralik === 'Aylƒ±k') {
                                    ilkTarih = monthStart;
                                    sonTarih = monthEnd;
                                } else if (aralik === 'K√ºm√ºlatif') {
                                    ilkTarih = yearStart;
                                    sonTarih = monthEnd;
                                } else {
                                    ilkTarih = bggStartDate;
                                    sonTarih = monthEnd;
                                }

                                rows.push({
                                    'M√ºd√ºrl√ºk': mudurluk,
                                    'Hizmet Ba≈ülƒ±ƒüƒ±': hizmet,
                                    'T√ºr': turData.tur,
                                    'Lokasyon': lokasyon,
                                    'Veri Aralƒ±ƒüƒ±': aralik,
                                    'ƒ∞lk Tarih': formatDate(ilkTarih),
                                    'Son Tarih': formatDate(sonTarih),
                                    'Veri Sorumlusu': turData.sorumlu,
                                    'G√ºncel Olup Olmadƒ±ƒüƒ±': '',
                                    'Eksik Giri≈ü': '',
                                    'Deƒüer': '',
                                    'Veri Giri≈ü Tarihi': ''
                                });
                            });
                        });
                    }

                    const ws = XLSX.utils.json_to_sheet(rows);
                    ws['!cols'] = [
                        { wch: 30 }, { wch: 35 }, { wch: 15 }, { wch: 18 }, { wch: 12 },
                        { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 15 }
                    ];

                    // Excel sheet adƒ± i√ßin yasak karakterleri temizle (: \ / ? * [ ])
                    const sanitizedTur = turData.tur.replace(/[:\\\/?*\[\]]/g, '-');
                    const sheetName = sanitizedTur.length > 31 ? sanitizedTur.substring(0, 31) : sanitizedTur;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);

                    if (withProtection) {
                        // K-L ≈üifresi yoksa kitap ≈üifresini kullan
                        turlerForProtection.push({
                            tur: turData.tur,
                            sifre: turData.sifre || kitapSifre,
                            kitapSifre: kitapSifre,
                            ilceDetay: turData.ilceDetay
                        });
                    }
                });

                // Excel'i buffer olarak olu≈ütur
                let xlsxBuffer = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });

                // Eƒüer koruma aktifse XML manip√ºle et
                if (withProtection && turlerForProtection.length > 0) {
                    try {
                        const fileZip = await JSZip.loadAsync(xlsxBuffer);
                        const kitapSifre = turlerForProtection[0].kitapSifre;

                        // Her sayfa i√ßin koruma ekle
                        for (let i = 0; i < turlerForProtection.length; i++) {
                            const sheetPath = `xl/worksheets/sheet${i + 1}.xml`;
                            const sheetFile = fileZip.file(sheetPath);

                            if (!sheetFile) {
                                console.error('Sheet bulunamadƒ±:', sheetPath);
                                continue;
                            }

                            let sheetXml = await sheetFile.async('string');

                            const turData = turlerForProtection[i];
                            const sheetPasswordHash = excelPasswordHash(kitapSifre);
                            const rangePasswordHash = excelPasswordHash(turData.sifre);

                            // Bu sayfa i√ßin lokasyon sayƒ±sƒ±nƒ± hesapla
                            const sheetLocations = turData.ilceDetay === 'ilce' ? ISTANBUL_ILCELERI : ['ƒ∞stanbul Geneli'];
                            const rowCount = sheetLocations.length * 12 * 3 + 1;
                            const editableRange = `K2:L${rowCount}`;

                            const protectionXml = `
                                <sheetProtection password="${sheetPasswordHash}" sheet="1" objects="1" scenarios="1" formatCells="0" formatColumns="0" formatRows="0" insertColumns="0" insertRows="0" insertHyperlinks="0" deleteColumns="0" deleteRows="0" selectLockedCells="0" sort="0" autoFilter="0" pivotTables="0" selectUnlockedCells="0"/>
                                <protectedRanges>
                                    <protectedRange sqref="${editableRange}" name="VeriGirisi_${i + 1}" password="${rangePasswordHash}"/>
                                </protectedRanges>
                            `;

                            sheetXml = sheetXml.replace('</sheetData>', '</sheetData>' + protectionXml);
                            fileZip.file(sheetPath, sheetXml);
                        }

                        // Workbook korumasƒ± ekle
                        let workbookXml = await fileZip.file('xl/workbook.xml').async('string');
                        const wbPasswordHash = excelPasswordHash(kitapSifre);
                        const workbookProtection = `<workbookProtection workbookPassword="${wbPasswordHash}" lockStructure="1"/>`;

                        workbookXml = workbookXml.replace('<sheets>', workbookProtection + '<sheets>');
                        fileZip.file('xl/workbook.xml', workbookXml);

                        xlsxBuffer = await fileZip.generateAsync({ type: 'arraybuffer' });
                    } catch (err) {
                        console.error('Koruma eklenirken hata:', hizmet, err);
                    }
                }

                // ZIP'e ekle
                const safeHizmet = hizmet.replace(/[^a-zA-Z0-9ƒü√º≈ü√∂√ßƒ±ƒ∞ƒû√ú≈û√ñ√á\s]/g, '').substring(0, 30);
                const filename = `${safeHizmet}_Veri_Taslak_${year}.xlsx`;
                zip.file(filename, xlsxBuffer);
                fileCount++;
            }
        }

        // ZIP'i indir
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = `Tum_Hizmetler_Veri_Taslak_${year}.zip`;
        link.click();
        URL.revokeObjectURL(link.href);

        closeTemplateWizard();

        const protectionMsg = withProtection ? '\n\nüîí T√ºm dosyalar korumalƒ± (Hizmet+T√ºr bazlƒ± ≈üifreler)' : '\n\n‚ö° ≈ûifresiz (hƒ±zlƒ±)';
        alert(`‚úÖ Toplu Excel paketi olu≈üturuldu!\n\nüì¶ ${fileCount} Excel dosyasƒ±\nüìÅ ZIP boyutu: ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB${protectionMsg}`);
    }

    async function generateDataTemplate() {
        // Mode kontrol√º
        const mode = document.querySelector('input[name="tpl-mode"]:checked').value;

        if (mode === 'bulk') {
            // Toplu mod
            await generateBulkExcelFiles();
            return;
        }

        // Tek dosya modu (mevcut akƒ±≈ü)
        let mudurluk = document.getElementById('tpl-mudurluk').value;
        let hizmet = document.getElementById('tpl-hizmet').value;

        // Yeni m√ºd√ºrl√ºk girildiyse onu kullan
        if (mudurluk === '__NEW__') {
            mudurluk = document.getElementById('tpl-mudurluk-new').value.trim();
            if (!mudurluk) {
                alert('L√ºtfen yeni m√ºd√ºrl√ºk adƒ±nƒ± girin!');
                showTemplateStep(1);
                return;
            }
        }

        // Yeni hizmet girildiyse onu kullan
        if (hizmet === '__NEW__') {
            hizmet = document.getElementById('tpl-hizmet-new').value.trim();
            if (!hizmet) {
                alert('L√ºtfen yeni hizmet adƒ±nƒ± girin!');
                showTemplateStep(1);
                return;
            }
        }

        // Se√ßili t√ºrleri ve sorumlu/≈üifre bilgilerini topla
        const turItems = document.querySelectorAll('#tpl-turler .tur-item');
        const turlerData = [];

        turItems.forEach(item => {
            const cb = item.querySelector('input[type="checkbox"]');
            if (cb && cb.checked) {
                const turName = cb.value;
                const sorumluInput = item.querySelector('.tur-sorumlu');
                const sifreInput = item.querySelector('.tur-sifre');

                turlerData.push({
                    tur: turName,
                    sorumlu: sorumluInput ? sorumluInput.value.trim() : '',
                    sifre: sifreInput ? sifreInput.value.trim() : ''
                });
            }
        });

        if (turlerData.length === 0) {
            alert('L√ºtfen en az bir t√ºr se√ßin!');
            showTemplateStep(1);
            return;
        }

        // ≈ûifresiz t√ºr var mƒ± kontrol et
        const sifresiztTurler = turlerData.filter(t => !t.sifre);
        if (sifresiztTurler.length > 0) {
            alert(`≈ûu t√ºrler i√ßin ≈üifre girilmedi: ${sifresiztTurler.map(t => t.tur).join(', ')}`);
            showTemplateStep(1);
            return;
        }

        const hasIlceDetail = document.querySelector('input[name="tpl-ilce"]:checked').value === 'yes';
        const year = parseInt(document.getElementById('tpl-year').value);
        const bggStart = document.getElementById('tpl-bgg-start').value;
        const kitapSifre = document.getElementById('tpl-kitap-sifre').value.trim();

        if (!bggStart) {
            alert('L√ºtfen BGG ba≈ülangƒ±√ß tarihini girin!');
            return;
        }

        if (!kitapSifre) {
            alert('L√ºtfen √ßalƒ±≈üma kitabƒ± koruma ≈üifresini girin!');
            return;
        }

        const bggStartDate = new Date(bggStart);
        const locations = hasIlceDetail ? ISTANBUL_ILCELERI : ['ƒ∞stanbul Geneli'];

        // Excel olu≈ütur
        const wb = XLSX.utils.book_new();

        turlerData.forEach(turData => {
            const rows = [];

            for (let month = 0; month < 12; month++) {
                const monthLastDay = getLastDayOfMonth(year, month);
                const yearStart = new Date(year, 0, 1);
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month, monthLastDay);

                ['Aylƒ±k', 'K√ºm√ºlatif', 'BGG'].forEach(aralik => {
                    locations.forEach(lokasyon => {
                        let ilkTarih, sonTarih;

                        if (aralik === 'Aylƒ±k') {
                            ilkTarih = monthStart;
                            sonTarih = monthEnd;
                        } else if (aralik === 'K√ºm√ºlatif') {
                            ilkTarih = yearStart;
                            sonTarih = monthEnd;
                        } else {
                            ilkTarih = bggStartDate;
                            sonTarih = monthEnd;
                        }

                        rows.push({
                            'M√ºd√ºrl√ºk': mudurluk,
                            'Hizmet Ba≈ülƒ±ƒüƒ±': hizmet,
                            'T√ºr': turData.tur,
                            'Lokasyon': lokasyon,
                            'Veri Aralƒ±ƒüƒ±': aralik,
                            'ƒ∞lk Tarih': formatDate(ilkTarih),
                            'Son Tarih': formatDate(sonTarih),
                            'Veri Sorumlusu': turData.sorumlu,
                            'G√ºncel Olup Olmadƒ±ƒüƒ±': '',
                            'Eksik Giri≈ü': '',
                            'Deƒüer': '',
                            'Veri Giri≈ü Tarihi': ''
                        });
                    });
                });
            }

            const ws = XLSX.utils.json_to_sheet(rows);
            ws['!cols'] = [
                { wch: 30 }, { wch: 35 }, { wch: 15 }, { wch: 18 }, { wch: 12 },
                { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 15 }
            ];

            const sheetName = turData.tur.length > 31 ? turData.tur.substring(0, 31) : turData.tur;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });

        // Excel'i buffer olarak olu≈ütur
        const xlsxBuffer = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });

        // JSZip ile a√ß ve XML'i manip√ºle et
        try {
            const zip = await JSZip.loadAsync(xlsxBuffer);

            // Her sayfa i√ßin koruma ekle
            for (let i = 0; i < turlerData.length; i++) {
                const sheetPath = `xl/worksheets/sheet${i + 1}.xml`;
                let sheetXml = await zip.file(sheetPath).async('string');

                const turData = turlerData[i];
                const sheetPasswordHash = excelPasswordHash(kitapSifre);
                const rangePasswordHash = excelPasswordHash(turData.sifre);

                // Satƒ±r sayƒ±sƒ±nƒ± hesapla (ba≈ülƒ±k + veri satƒ±rlarƒ±)
                const rowCount = locations.length * 12 * 3 + 1;

                // K ve L s√ºtunlarƒ± i√ßin d√ºzenlenebilir aralƒ±k (K2:L{rowCount})
                const editableRange = `K2:L${rowCount}`;

                // sheetProtection ve protectedRanges ekle
                const protectionXml = `
                    <sheetProtection password="${sheetPasswordHash}" sheet="1" objects="1" scenarios="1" formatCells="0" formatColumns="0" formatRows="0" insertColumns="0" insertRows="0" insertHyperlinks="0" deleteColumns="0" deleteRows="0" selectLockedCells="0" sort="0" autoFilter="0" pivotTables="0" selectUnlockedCells="0"/>
                    <protectedRanges>
                        <protectedRange sqref="${editableRange}" name="VeriGirisi_${i + 1}" password="${rangePasswordHash}"/>
                    </protectedRanges>
                `;

                // </sheetData> tagƒ±ndan sonra ekle
                sheetXml = sheetXml.replace('</sheetData>', '</sheetData>' + protectionXml);

                zip.file(sheetPath, sheetXml);
            }

            // Workbook korumasƒ± ekle
            let workbookXml = await zip.file('xl/workbook.xml').async('string');
            const wbPasswordHash = excelPasswordHash(kitapSifre);
            const workbookProtection = `<workbookProtection workbookPassword="${wbPasswordHash}" lockStructure="1"/>`;

            // <sheets> tagƒ±ndan √∂nce ekle
            workbookXml = workbookXml.replace('<sheets>', workbookProtection + '<sheets>');
            zip.file('xl/workbook.xml', workbookXml);

            // Korumalƒ± dosyayƒ± olu≈ütur
            const protectedBlob = await zip.generateAsync({ type: 'blob' });

            // ƒ∞ndir
            const safeHizmet = hizmet.replace(/[^a-zA-Z0-9ƒü√º≈ü√∂√ßƒ±ƒ∞ƒû√ú≈û√ñ√á\s]/g, '').substring(0, 30);
            const filename = `${safeHizmet}_Veri_Taslak_${year}.xlsx`;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(protectedBlob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);

            closeTemplateWizard();

            // √ñzet bilgi
            const turSummary = turlerData.map(t => `‚Ä¢ ${t.tur}: ${t.sorumlu} (≈üifre: ${t.sifre})`).join('\n');
            alert(`‚úÖ "${filename}" ba≈üarƒ±yla olu≈üturuldu!\n\nüìä ${turlerData.length} sayfa, toplam ${locations.length * 12 * 3 * turlerData.length} satƒ±r\n\nüîí Koruma Bilgileri:\n‚Ä¢ Kitap ≈üifresi: ${kitapSifre}\n‚Ä¢ K-L s√ºtunlarƒ± d√ºzenleme:\n${turSummary}`);

        } catch (err) {
            console.error('Excel koruma hatasƒ±:', err);
            alert('Excel koruma eklenirken hata olu≈ütu: ' + err.message);
        }
    }
</script>

</html>